<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlazingQuiz.Web</title>
    <base href="/" />
    <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="stylesheet" href="css/custom-button.css" />
    <link rel="stylesheet" href="css/card-3d-raised.css" />
    <!--<link rel="stylesheet" href="css/navmenu-theme.css" />-->
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="BlazingQuiz.Web.styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Coiny&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Borel&display=swap" rel="stylesheet">

</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ðŸ—™</a>
    </div>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="_framework/blazor.webassembly.js"></script>
    <script src="js/theme.js"></script>
    <script>
        window.loadGoogleSDK = () => {
            return new Promise((resolve, reject) => {
                // Initialize Google Identity Services
                if (window.google) {
                    initGoogleLogin(resolve, reject);
                } else {
                    // Wait for Google SDK to load
                    window.addEventListener('google-loaded', () => {
                        initGoogleLogin(resolve, reject);
                    });
                }
            });
        };

        function initGoogleLogin(resolve, reject) {
            try {
                // Clean up any existing button first
                const existingButton = document.getElementById('google-signin-button');
                if (existingButton) {
                    existingButton.remove();
                }

                google.accounts.id.initialize({
                    client_id: "359773753837-b8869mrinifr1lb42mknpu0ieosrlcjp.apps.googleusercontent.com",
                    callback: handleGoogleCredentialResponse,
                    auto_select: false,
                    cancel_on_tap_outside: true
                });

                // Show the Google account picker directly
                google.accounts.id.prompt(notification => {
                    if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                        // If the prompt is not displayed, fall back to the button method
                        // Create a temporary button for login
                        const buttonDiv = document.createElement('div');
                        buttonDiv.id = 'google-signin-button';
                        buttonDiv.style.position = 'absolute';
                        buttonDiv.style.left = '-9999px'; // Hide the button off-screen
                        document.body.appendChild(buttonDiv);

                        google.accounts.id.renderButton(
                            document.getElementById('google-signin-button'),
                            { theme: 'outline', size: 'large' }
                        );

                        // Trigger the button click programmatically to show the Google login prompt
                        setTimeout(() => {
                            const button = document.querySelector('#google-signin-button > iframe');
                            if (button) {
                                button.click(); // Trigger the button click to show Google login
                            }
                        }, 300);
                    }
                });

                resolve();
            } catch (error) {
                reject(error);
            }
        }

        function handleGoogleCredentialResponse(response) {
            // Store the token in a global variable that can be accessed by Blazor
            window.googleToken = response.credential;

            // Try to call the registered login component
            if (window.loginComponent) {
                window.loginComponent.invokeMethodAsync('HandleGoogleToken', response.credential)
                    .then(result => {
                        console.log('Google login successful:', result);
                    })
                    .catch(error => {
                        console.error('Google login error (component call):', error);
                    });
            } else {
                console.error('Login component not registered. Blazor component may not be loaded yet.');
                // Alternative: try to invoke directly if Blazor is available
                if (window.DotNet) {
                    DotNet.invokeMethodAsync('BlazingQuiz.Web', 'ProcessGoogleToken', response.credential)
                        .then(result => {
                            console.log('Google login successful:', result);
                        })
                        .catch(error => {
                            console.error('Google login error (direct call):', error);
                        });
                }
            }

            // Clean up the temporary button
            const buttonDiv = document.getElementById('google-signin-button');
            if (buttonDiv) {
                buttonDiv.remove();
            }
        }

        // Add a global function to handle the token from Blazor
        window.processGoogleToken = (token) => {
            // This will be called from Blazor to handle the token
            const response = { credential: token };
            handleGoogleCredentialResponse(response);
        };

        // Global variable to store the login component reference
        window.loginComponent = null;

        // Function to register the login component
        window.registerLoginComponent = (componentRef) => {
            window.loginComponent = componentRef;
        };
    </script>
</body>

</html>
