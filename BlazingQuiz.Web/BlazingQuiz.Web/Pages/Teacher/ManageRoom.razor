@page "/teacher/rooms"
@using BlazingQuiz.Shared.DTOs
@using BlazingQuiz.Web.Services
@inject IRoomApi RoomApi
@inject IStorageService LocalStorage
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@attribute [Authorize(Roles = nameof(UserRole.Teacher))]

<PageTitle>Manage Rooms - Teacher</PageTitle>

<div class="container">
    <!-- Hanging container with 2 ropes -->
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- Hanging container with 2 ropes -->
            <div class="hanging-container">
                <div class="hanging-content">
                    <h3>Manage My Rooms</h3>
                </div>
                <!-- Ropes connecting hanging container to main card -->
                <div class="rope left-rope"></div>
                <div class="rope right-rope"></div>
            </div>
        </div>
    </div>

    <BackButton />
    <!-- Search section: Similar to category management page -->
    <div class="row mb-3 mt-4">
        <div class="col-12">
            <div class="position-relative">
                <input type="text"
                       class="form-control ps-4"
                       placeholder="Search rooms by name or code..."
                       @bind="_searchTerm"
                       @bind:event="oninput" />
                <span class="position-absolute start-0 top-50 translate-middle-y ms-2">
                    <i class="fas fa-search text-muted"></i>
                </span>
                @if (!string.IsNullOrEmpty(_searchTerm))
                {
                    <button class="position-absolute end-0 top-50 translate-middle-y me-2 btn btn-link p-0 text-decoration-none"
                            type="button"
                            style="border: none; background: none; color: #6c757d;"
                            @onclick="() => { _searchTerm = string.Empty; }">
                        <i class="fas fa-times"></i>
                    </button>
                }
            </div>
        </div>
    </div>
    <!-- Top section: Create Room button and Refresh -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <a href="/teacher/createroom" class="btn btn-3d btn-3d-success">Create Room</a>
                <button class="btn btn-3d btn-3d-primary" @onclick="RefreshRooms" disabled="@isProcessing">
                    <span class="bi bi-arrow-repeat"></span> Refresh
                </button>
            </div>
        </div>
    </div>
    <!-- Bottom section: Room grid -->
    <div class="row">
        <div class="col-12">
            <h3>My Rooms</h3>
            @{
                var filteredRooms = FilterRooms();
            }

            @if(filteredRooms == null || !filteredRooms.Any())
            {
                <div class="text-center">
                    <p class="text-danger h5">@(!string.IsNullOrEmpty(_searchTerm) ? "No rooms found" : "No rooms available")</p>
                    @if (isLoading == false && string.IsNullOrEmpty(_searchTerm))
                    {
                        <a href="/teacher/createroom" class="btn btn-3d btn-3d-primary">Create Your First Room</a>
                    }
                </div>
            }
            else
            {
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3">
                    @foreach (var room in filteredRooms)
                    {
                        <div class="col">
                            <div class="card room-card room-card-3d" title="@room.Name">
                                <div class="card-body d-flex flex-column">
                                    <h3 class="card-title text-center">@room.Name</h3>
                                    <div class="room-details mb-2">
                                        <p class="mb-1"><strong>Code:</strong> @room.Code</p>
                                        <p class="mb-1"><strong>Status:</strong>
                                            @if (ShouldShowViewResultsButton(room.Id))
                                            {
                                                <span class="text-success">Quiz Completed</span>
                                            }
                                            else if (room.IsActive)
                                            {
                                                <span class="text-primary">Active</span>
                                            }
                                            else
                                            {
                                                <span class="text-secondary">Not Started</span>
                                            }
                                        </p>
                                    </div>
                                    <div class="mt-auto d-flex justify-content-center">
                                        <button type="button" class="btn-room-action" @onclick="() => ViewDetails(room.Id)" disabled="@isProcessing" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn-room-action btn-room-action-info" @onclick="() => CopyRoomCode(room.Code)" disabled="@isProcessing" title="Copy Code">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        @if (ShouldShowViewResultsButton(room.Id))
                                        {
                                            <button type="button" class="btn-room-action btn-room-action-success" @onclick="() => ViewResults(room.Id)" disabled="@isProcessing" title="View Results">
                                                <i class="fas fa-chart-bar"></i>
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                @if (rooms != null && rooms.Any() && isLoading)
                {
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(_searchTerm) && filteredRooms.Any() == false)
                {
                    <div class="text-center mt-4">
                        <p class="text-muted">No rooms found matching "@_searchTerm"</p>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    private List<RoomDto>? rooms;
    private bool isLoading = true;
    private bool isProcessing = false;
    private Dictionary<Guid, int> participantCounts = new();
    private Dictionary<Guid, bool> allParticipantsSubmitted = new();
    private string _searchTerm = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadRooms();
    }

    private async Task LoadRooms()
    {
        try
        {
            isLoading = true;
            rooms = (await RoomApi.GetRoomsAsync()).ToList();

            // Load participant counts and submission status for each room
            if (rooms != null)
            {
                foreach (var room in rooms)
                {
                    try
                    {
                        var participants = await RoomApi.GetRoomParticipantsAsync(room.Id);
                        participantCounts[room.Id] = participants.Length;

                        // Check if all participants have submitted
                        var submissionStatus = await RoomApi.GetSubmissionStatusAsync(room.Id);
                        if (submissionStatus.Length > 0)
                        {
                            bool allSubmitted = submissionStatus.All(p => p.HasSubmitted == true);
                            allParticipantsSubmitted[room.Id] = allSubmitted;
                        }
                        else
                        {
                            allParticipantsSubmitted[room.Id] = false;
                        }
                    }
                    catch
                    {
                        // If we can't get participant count or submission status, default to 0 and false
                        participantCounts[room.Id] = 0;
                        allParticipantsSubmitted[room.Id] = false;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            // Log error or show notification
            Console.WriteLine($"Error loading rooms: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private List<RoomDto>? FilterRooms()
    {
        if (rooms == null)
            return null;

        if (string.IsNullOrWhiteSpace(_searchTerm))
            return rooms;

        var searchTermLower = _searchTerm.ToLowerInvariant();
        return rooms.Where(r =>
            r.Name.ToLowerInvariant().Contains(searchTermLower) ||
            r.Code.ToLowerInvariant().Contains(searchTermLower)
        ).ToList();
    }

    private int GetParticipantCount(Guid roomId)
    {
        return participantCounts.TryGetValue(roomId, out var count) ? count : 0;
    }

    private void ViewDetails(Guid roomId)
    {
        Navigation.NavigateTo($"/teacher/rooms/{roomId}");
    }

    private async Task EndRoom(Guid roomId)
    {
        bool confirmed = await ConfirmEndRoom();
        if (!confirmed)
        {
            return; // User cancelled the action
        }

        try
        {
            isProcessing = true;

            var response = await RoomApi.EndRoomAsync(roomId);
            if (response.IsSuccessStatusCode)
            {
                // Reload rooms to reflect the changes
                await LoadRooms();
                await JSRuntime.InvokeVoidAsync("alert", "Room ended successfully!");
            }
            else
            {
                Console.WriteLine($"Error ending room: {response.Error}");
                await JSRuntime.InvokeVoidAsync("alert", $"Failed to end room: {response.Error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error ending room: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error ending room: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private bool ShouldShowViewResultsButton(Guid roomId)
    {
        return allParticipantsSubmitted.TryGetValue(roomId, out bool submitted) && submitted;
    }

    private void ViewResults(Guid roomId)
    {
        Navigation.NavigateTo($"/teacher/rooms/{roomId}/leaderboard");
    }

    private async Task RefreshRooms()
    {
        await LoadRooms();
    }

    private async Task<bool> ConfirmEndRoom()
    {
        return await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to end this room? This will stop any ongoing quiz activity.");
    }

    private async Task CopyRoomCode(string roomCode)
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", roomCode);
        await JSRuntime.InvokeVoidAsync("alert", $"Room code '{roomCode}' copied to clipboard!");
    }
}