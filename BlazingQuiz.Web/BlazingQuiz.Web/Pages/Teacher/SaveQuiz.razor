@page "/teacher/add-quiz"
@page "/teacher/edit-quiz/{quizId:guid?}"

@using BlazingQuiz.Shared
@using BlazingQuiz.Shared.DTOs
@using BlazingQuiz.Shared.Enums
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = nameof(UserRole.Teacher))]

@inject NavigationManager NavigationManager
@inject IQuizApi QuizApi
@inject ICategoryApi CategoryApi
@inject IJSRuntime JsRuntime
@inject IAppState AppState
@inject QuizImageService QuizImageService
@inject QuestionImageService QuestionImageService
@inject QuizAudioService QuizAudioService
@inject QuestionAudioService QuestionAudioService

<EditForm Model="_quiz" OnValidSubmit="SaveQuizAsync">
    <DataAnnotationsValidator />

    <!-- Slider Container -->
    <div class="slider-container">
        <div class="slider-track" style="transform: translateX(@(CurrentCardIndex * -100)%);">
            <!-- Card 1: Quiz Information -->
            <div class="slider-card">
                <div class="card-header-3d">
                    <h4 class="m-0">Quiz Information</h4>
                </div>

                <div class="card-body">
                    <div class="row">
                        <!-- Left side: Quiz Title, Name, and Image -->
                        <div class="col-md-6 border-end">
                            <div class="mb-3">
                                <label for="quizName" class="form-label">Name</label>
                                <input id="quizName" class="form-control form-control-centered" @bind="_quiz.Name" placeholder="Enter quiz name" style="font-size: 1.1rem; letter-spacing: 0.1rem;" />
                                <ValidationMessage For="() => _quiz.Name" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Quiz Image</label>
                                @if (!string.IsNullOrEmpty(_quiz.ImagePath))
                                {
                                    <div class="mb-2">
                                        <img src="@QuizImageService.GetImageUrl(_quiz.ImagePath)" alt="Quiz Image" class="img-thumbnail w-100" style="max-height: 200px; object-fit: cover;" />
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-3d btn-3d-danger" @onclick="RemoveImageAsync" title="Remove Image">Remove Image</button>
                                        </div>
                                    </div>
                                }
                                <FileUpload CurrentFile="_selectedImageFile"
                                           OnFileChanged="OnImageFileChanged"
                                           AcceptedFileTypes="image/*"
                                           MaxFileSize="10 * 1024 * 1024"
                                           UploadText="Click or drag image here to upload"
                                           UploadHint="Supports JPG, PNG, GIF up to 10MB" />
                            </div>
                        </div>

                        <!-- Right side: Remaining Information -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quizDescription" class="form-label">Description</label>
                                <input id="quizDescription" class="form-control form-control-centered" @bind="_quiz.Description" placeholder="Enter a description for the quiz" style="font-size: 1.1rem; letter-spacing: 0.1rem;" />
                            </div>
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="mb-3">
                                        <label class="form-label">Categories</label>
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="categoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                @if (_quiz.CategoryIds.Count == 0)
                                                {
                                                    <span>Select categories...</span>
                                                }
                                                else
                                                {
                                                    <span>@_quiz.CategoryIds.Count selected</span>
                                                }
                                            </button>
                                            <ul class="dropdown-menu w-100" aria-labelledby="categoryDropdown">
                                                @foreach (var category in _categories)
                                                {
                                                    <li>
                                                        <a class="dropdown-item" href="javascript:void(0);" @onclick="() => OnCategorySelectionChanged(category.Id)">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="cat_@category.Id" checked="@(_quiz.CategoryIds.Contains(category.Id))" />
                                                                <label class="form-check-label" for="cat_@category.Id">@category.Name</label>
                                                            </div>
                                                        </a>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                        <!-- Display selected categories as tags -->
                                        <div class="mt-2">
                                            @foreach (var catId in _quiz.CategoryIds.ToList())
                                            {
                                                var category = _categories.FirstOrDefault(c => c.Id == catId);
                                                if (category != null)
                                                {
                                                    <span class="badge bg-primary me-1 mb-1">
                                                        @category.Name
                                                        <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.6em;" @onclick="() => RemoveCategory(catId)"></button>
                                                    </span>
                                                }
                                            }
                                        </div>
                                        <ValidationMessage For="() => _quiz.CategoryIds" />
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="mb-3">
                                        <label for="quizLevel" class="form-label">Level</label>
                                        <select id="quizLevel" class="form-control form-control-centered" @bind="_quiz.Level" style="font-size: 1.1rem; letter-spacing: 0.1rem;">
                                            <option value="">Select level</option>
                                            <option value="@BlazingQuiz.Shared.Enums.QuizLevel.Easy">@BlazingQuiz.Shared.Enums.QuizLevel.Easy</option>
                                            <option value="@BlazingQuiz.Shared.Enums.QuizLevel.Normal">@BlazingQuiz.Shared.Enums.QuizLevel.Normal</option>
                                            <option value="@BlazingQuiz.Shared.Enums.QuizLevel.Hard">@BlazingQuiz.Shared.Enums.QuizLevel.Hard</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="mb-3">
                                        <label for="totalQuestions" class="form-label">Total Questions</label>
                                        <input id="totalQuestions" type="number" class="form-control form-control-centered" value="@_quiz.Questions.Count" readonly style="font-size: 1.1rem; letter-spacing: 0.1rem;" />
                                        <ValidationMessage For="() => _quiz.TotalQuestions" />
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="mb-3">
                                        <label for="timeInMinutes" class="form-label">Time (in minutes)</label>
                                        <input id="timeInMinutes" type="number" class="form-control form-control-centered" @bind="_quiz.TimeInMinutes" min="0" style="font-size: 1.1rem; letter-spacing: 0.1rem;" />
                                        <ValidationMessage For="() => _quiz.TimeInMinutes" />
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="mb-3">
                                        <div class="form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch" id="quizIsActive" @bind="_quiz.IsActive" />
                                            <label class="form-check-label" for="quizIsActive">Is Active?</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation buttons -->
                @if (_quiz.Questions.Count > 0)
                {
                    <button type="button" class="btn btn-3d btn-3d-primary next-btn" @onclick="() => GoToCard(1)">Next</button>
                }
            </div>

            <!-- Cards for Questions -->
            @for (int i = 0; i < _quiz.Questions.Count; i++)
            {
                var question = _quiz.Questions[i];
                var questionIndex = i;

                <div class="slider-card">
                    <div class="card-header-3d">
                        <h4 class="m-0">Question @(i + 1)</h4>
                    </div>

                    <div class="question-card-content">
                        <div class="mb-3">
                            <label class="form-label">Question Text</label>
                            <textarea @bind="question.Text" class="form-control" rows="3"></textarea>
                            <button type="button" class="btn btn-3d btn-3d-danger mt-2" @onclick="() => DeleteQuestionAsync(question)" title="Delete Question">Delete Question</button>
                        </div>

                        <!-- Question Type Selection -->
                        <div class="mb-3">
                            <h6>Question Type</h6>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="questionType_@questionIndex" value="multiple-choice" checked="@(!question.IsTextAnswer)" @onchange="() => { question.IsTextAnswer = false; OnQuestionTypeChanged(question); }">
                                <label class="form-check-label">Multiple Choice</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="questionType_@questionIndex" value="text-input" checked="@(question.IsTextAnswer)" @onchange="() => { question.IsTextAnswer = true; OnQuestionTypeChanged(question); }">
                                <label class="form-check-label">Text Input</label>
                            </div>
                        </div>

                        <!-- Question Image Upload Section -->
                        <div class="mb-3">
                            <label class="form-label">Question Image</label>
                            @if (!string.IsNullOrEmpty(question.ImagePath))
                            {
                                <div class="mb-2">
                                    <img src="@QuestionImageService.GetImageUrl(question.ImagePath)" alt="Question Image" class="img-thumbnail" style="max-width: 150px; max-height: 150px;" />
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-3d btn-3d-danger" @onclick="() => RemoveQuestionImageAsync(question)" title="Remove Question Image">Remove Image</button>
                                    </div>
                                </div>
                            }
                            <FileUpload CurrentFile="@GetQuestionImageFile(question)"
                                       OnFileChanged="@(file => OnQuestionImageFileChanged(question, file))"
                                       AcceptedFileTypes="image/*"
                                       MaxFileSize="10 * 1024 * 1024"
                                       UploadText="Click or drag question image to upload"
                                       UploadHint="Supports JPG, PNG, GIF up to 10MB" />
                        </div>

                        <!-- Answer Explanation Section -->
                        <div class="mb-3">
                            <label class="form-label">Answer Explanation</label>
                            <input type="text" class="form-control form-control-centered" @bind="question.AnswerExplanation" placeholder="Enter explanation for the correct answer" style="font-size: 1.1rem; letter-spacing: 0.1rem;" />
                        </div>

                        <!-- Question Audio Upload Section -->
                        <div class="mb-3">
                            <label class="form-label">Question Audio (MP3)</label>
                            @if (!string.IsNullOrEmpty(question.AudioPath))
                            {
                                <div class="mb-2">
                                    @if (question.AudioPath.EndsWith(".mp3", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <audio controls class="w-100">
                                            <source src="@QuestionAudioService.GetAudioUrl(question.AudioPath)" type="audio/mpeg" />
                                            Your browser does not support the audio element.
                                        </audio>
                                    }
                                    else
                                    {
                                        <span>Audio file: @question.AudioPath</span>
                                    }
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-3d btn-3d-danger" @onclick="() => RemoveQuestionAudioAsync(question)" title="Remove Question Audio">Remove Audio</button>
                                    </div>
                                </div>
                            }
                            <FileUpload CurrentFile="@GetQuestionAudioFile(question)"
                                       OnFileChanged="@(file => OnQuestionImageFileChanged(question, file))"
                                       AcceptedFileTypes=".mp3,audio/*"
                                       MaxFileSize="20 * 1024 * 1024"
                                       UploadText="Click or drag MP3 file to upload"
                                       UploadHint="Supports MP3 files up to 20MB" />
                        </div>

                        @if (!question.IsTextAnswer)
                        {
                            <!-- Multiple Choice Options -->
                            <h6>Options</h6>
                            <ol>
                                @foreach (var o in question.Options)
                                {
                                    var optionIndex = question.Options.IndexOf(o);
                                    <li class="p-2 mb-2">
                                        <div class="input-group">
                                            <div class="input-group-text">
                                                <input class="form-check-input mt-0" type="radio" name="option_radio_@questionIndex" checked="@o.IsCorrect" @onchange="() => SetOptionAsCorrectAnswer(question, o)">
                                            </div>
                                            <input type="text" class="form-control" aria-label="Text input with checkbox" @bind="o.Text"/>
                                            <button type="button" class="btn btn-3d btn-3d-danger" @onclick="() => question.Options.Remove(o)">X</button>
                                        </div>
                                    </li>
                                }
                            </ol>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-3d btn-3d-primary" @onclick="() => AddOptionToQuestion(question)">+ Add Option</button>
                            </div>
                        }
                        else
                        {
                            <!-- Text Input Answer -->
                            <h6>Possible Correct Answers</h6>
                            <div class="mb-3">
                                @if (question.TextAnswers != null)
                                {
                                    @foreach (var textAnswer in question.TextAnswers.ToList()) // Use ToList() to avoid collection modification during enumeration
                                    {
                                        var textAnswerIndex = question.TextAnswers.IndexOf(textAnswer);
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" placeholder="Enter a correct answer" @bind="textAnswer.Text"/>
                                            <button type="button" class="btn btn-3d btn-3d-danger" @onclick="() => question.TextAnswers.Remove(textAnswer)">X</button>
                                        </div>
                                    }
                                }
                                <button type="button" class="btn btn-3d btn-3d-primary" @onclick="() => question.TextAnswers.Add(new TextAnswerDto())">+ Add Correct Answer</button>
                            </div>
                        }
                    </div>

                </div>
            }

        </div>

        <!-- Navigation buttons for the whole slider -->
        @if (CurrentCardIndex > 0)
        {
            <button type="button" class="nav-btn prev-btn" @onclick="GoToPrevCard">❮</button>
        }

        @if (CurrentCardIndex < TotalCards - 1)
        {
            <button type="button" class="nav-btn next-btn" @onclick="GoToNextCard">❯</button>
        }
    </div>
</EditForm>

<!-- Add Question Button positioned on the right side -->
<button type="button" class="add-question-btn" @onclick="AddNewQuestion" title="Add Question">
    +
</button>

<!-- Save Quiz Button positioned at the bottom like the Add Question button -->
<button type="submit" class="save-quiz-btn" title="Save Quiz">
    Save Quiz
</button>

@code {
    [Parameter]
    public Guid? QuizId { get; set; }

    private bool IsEditCase => QuizId.HasValue && QuizId.Value != Guid.Empty;

    private QuizSaveDto _quiz = new();

    private CategoryDto[] _categories = [];

    private IBrowserFile? _selectedImageFile;
    private IBrowserFile? _selectedAudioFile;
    private int _imageUploadProgress;
    private int _audioUploadProgress;

    private int CurrentCardIndex { get; set; } = 0;

    private int TotalCards => 1 + _quiz.Questions.Count; // 1 for quiz info + number of questions

    protected override async Task OnInitializedAsync()
    {
        AppState.ShowLoader("Loading categories");
        _categories = await CategoryApi.GetCategoriesAsync();
        AppState.HideLoader();

        if (IsEditCase)
        {
            //Fetch _quiz from API
            AppState.ShowLoader("Loading Quiz");
            var quiz = await QuizApi.GetQuizToEditAsync(QuizId!.Value);
            AppState.HideLoader();
            if (quiz == null)
            {
                await ShowAlertAsync("Quiz not found.");
                NavigationManager.NavigateTo("/teacher/manage-quizzes");
                return;
            }
            _quiz = quiz;
            // Update TotalQuestions to reflect the actual count
            _quiz.TotalQuestions = _quiz.Questions.Count;
        }
        else
        {
            var question = GetDefaultEmptyQuestion();
            _quiz.Questions = [question];
            // Update TotalQuestions to reflect the actual count
            _quiz.TotalQuestions = _quiz.Questions.Count;
        }
    }

    protected override void OnParametersSet()
    {
        if(!QuizId.HasValue && _quiz.Id != Guid.Empty)
        {
            //We are in EditMode, and we clicked on Add new Quiz on the left nav menu
            _quiz = new();
            _quiz.Questions = [GetDefaultEmptyQuestion()];
            // Update TotalQuestions to reflect the actual count
            _quiz.TotalQuestions = _quiz.Questions.Count;
            CurrentCardIndex = 0; // Reset to first card
        }
    }

    private QuestionDto GetDefaultEmptyQuestion() =>  new QuestionDto
        {
            Options = [new(), new()],
            TextAnswers = [],
            IsTextAnswer = false
        };

    private void SetOptionAsCorrectAnswer(QuestionDto q, OptionDto o)
    {
        foreach (var option in q.Options)
        {
            option.IsCorrect = false;
        }
        o.IsCorrect = true;
    }

    private async Task SaveQuizAsync()
    {
        var errorMessage = _quiz.Validate();
        if (!string.IsNullOrEmpty(errorMessage))
        {
            await ShowAlertAsync(errorMessage);
            return;
        }

        AppState.ShowLoader("Saving quiz");
        var response = await QuizApi.SaveQuizAsync(_quiz);
        AppState.HideLoader();

        if (!response.IsSuccess)
        {
            await ShowAlertAsync(response.ErrorMessage);
            return;
        }

        // If we have a new image to upload, do it after saving the quiz
        if (_selectedImageFile != null && _quiz.Id != Guid.Empty)
        {
            AppState.ShowLoader("Uploading quiz image...");
            try
            {
                // Since QuizImageService doesn't currently support progress tracking, we'll simulate it
                for (int i = 0; i <= 100; i += 10)
                {
                    _imageUploadProgress = i;
                    StateHasChanged();
                    await Task.Delay(50); // Simulate progress
                }

                var result = await QuizImageService.UploadQuizImageAsync(_quiz.Id, _selectedImageFile);

                if (result.IsSuccess)
                {
                    // Update the current quiz with the new image path (we need to reload quiz to get the updated image path)
                    var updatedQuiz = await QuizApi.GetQuizToEditAsync(_quiz.Id);
                    if (updatedQuiz != null)
                    {
                        _quiz.ImagePath = updatedQuiz.ImagePath; // Get the actual path from the database
                    }
                }
                else
                {
                    await ShowAlertAsync($"Failed to upload quiz image: {result.ErrorMessage}");
                }
            }
            catch (Exception ex)
            {
                await ShowAlertAsync($"Failed to upload quiz image: {ex.Message}");
            }
            finally
            {
                AppState.HideLoader();
                _imageUploadProgress = 0;
                _selectedImageFile = null;
            }
        }

        // If we have a new audio file to upload, do it after saving the quiz
        if (_selectedAudioFile != null && _quiz.Id != Guid.Empty)
        {
            AppState.ShowLoader("Uploading quiz audio...");
            try
            {
                var result = await QuizAudioService.UploadQuizAudioAsync(_quiz.Id, _selectedAudioFile);

                if (result.IsSuccess)
                {
                    // Update the current quiz with the new audio path (we need to reload quiz to get the updated audio path)
                    var updatedQuiz = await QuizApi.GetQuizToEditAsync(_quiz.Id);
                    if (updatedQuiz != null)
                    {
                        _quiz.AudioPath = updatedQuiz.AudioPath; // Get the actual path from the database
                    }
                }
                else
                {
                    await ShowAlertAsync($"Failed to upload quiz audio: {result.ErrorMessage}");
                }
            }
            catch (Exception ex)
            {
                await ShowAlertAsync($"Failed to upload quiz audio: {ex.Message}");
            }
            finally
            {
                AppState.HideLoader();
                _selectedAudioFile = null;
            }
        }

        // Handle question images and audio upload after the quiz is saved
        if (_quiz.Id != Guid.Empty)
        {
            AppState.ShowLoader("Uploading question media...");
            try
            {
                // Reload the quiz to get the actual question IDs after saving
                var updatedQuiz = await QuizApi.GetQuizToEditAsync(_quiz.Id);
                if (updatedQuiz != null)
                {
                    foreach (var question in updatedQuiz.Questions)
                    {
                        // Find the corresponding question in the original list to get its image file
                        var originalQuestion = _quiz.Questions.FirstOrDefault(q =>
                            q.Text == question.Text &&
                            (q.Id == question.Id || q.Id == 0) // Match by ID if available, or by text if it's new
                        );

                        if (originalQuestion != null && _questionImageFiles.ContainsKey(originalQuestion) && _questionImageFiles[originalQuestion] != null)
                        {
                            var questionImageFile = _questionImageFiles[originalQuestion];

                            // Upload the image for this question if there's an image file
                            if (questionImageFile != null)
                            {
                                var result = await QuestionImageService.UploadQuestionImageAsync(question.Id, questionImageFile);
                                if (!result.IsSuccess)
                                {
                                    await ShowAlertAsync($"Failed to upload image for question '{question.Text}': {result.ErrorMessage}");
                                }
                            }
                        }

                        // Handle audio file upload for this question
                        if (originalQuestion != null && _questionAudioFiles.ContainsKey(originalQuestion) && _questionAudioFiles[originalQuestion] != null)
                        {
                            var questionAudioFile = _questionAudioFiles[originalQuestion];

                            // Upload the audio for this question if there's an audio file
                            if (questionAudioFile != null)
                            {
                                var result = await QuestionAudioService.UploadQuestionAudioAsync(question.Id, questionAudioFile);
                                if (!result.IsSuccess)
                                {
                                    await ShowAlertAsync($"Failed to upload audio for question '{question.Text}': {result.ErrorMessage}");
                                }
                            }
                        }
                    }

                    // Now reload the quiz again to get the updated image and audio paths
                    var quizWithMedia = await QuizApi.GetQuizToEditAsync(_quiz.Id);
                    if (quizWithMedia != null)
                    {
                        // Update the current quiz with the image and audio paths
                        foreach (var question in _quiz.Questions)
                        {
                            var updatedQuestion = quizWithMedia.Questions.FirstOrDefault(q => q.Id == question.Id);
                            if (updatedQuestion != null)
                            {
                                question.ImagePath = updatedQuestion.ImagePath;
                                question.AudioPath = updatedQuestion.AudioPath;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                await ShowAlertAsync($"Failed to upload question images: {ex.Message}");
            }
            finally
            {
                AppState.HideLoader();
            }
        }

        NavigationManager.NavigateTo("/teacher/manage-quizzes");
        // if (_quiz.TotalQuestions != _quiz.Questions.Count)
        // {
        //     await ShowAlertAsync("Total Questions must be equal to the number of questions added.");
        //     return;
        // }
        // if(_quiz.Questions.Any(q => string.IsNullOrWhiteSpace(q.Text)))
        // {
        //     await ShowAlertAsync("Question text is required.");
        //     return;
        // }
        // if (_quiz.Questions.Any(q => q.Options.Count == 0))
        // {
        //     await ShowAlertAsync("Option are required for questions.");
        //     return;
        // }
    }

    private async Task ShowAlertAsync(string message, string title = "Error") =>
        await JsRuntime.InvokeVoidAsync("alert", $"{title}\n{message}");

    private async Task<bool> ShowConfirmAsync(string message) =>
        await JsRuntime.InvokeAsync<bool>("confirm", message);

    private async Task DeleteQuestionAsync(QuestionDto question)
    {
        bool confirmed = await ShowConfirmAsync("Are you sure you want to delete this question?");
        if (confirmed)
        {
            _quiz.Questions.Remove(question);
            // Update TotalQuestions to reflect the actual count
            _quiz.TotalQuestions = _quiz.Questions.Count;
        }
    }

    private void AddNewQuestion()
    {
        _quiz.Questions.Add(GetDefaultEmptyQuestion());
        // Update TotalQuestions to reflect the actual count
        _quiz.TotalQuestions = _quiz.Questions.Count;
        StateHasChanged();
    }

    private void RemoveCategory(int categoryId)
    {
        _quiz.CategoryIds.Remove(categoryId);
    }

    private void OnCategorySelectionChanged(int categoryId)
    {
        if (_quiz.CategoryIds.Contains(categoryId))
        {
            _quiz.CategoryIds.Remove(categoryId);
        }
        else
        {
            _quiz.CategoryIds.Add(categoryId);
        }
    }

    private async Task RemoveImageAsync()
    {
        if (_quiz.Id == Guid.Empty)
        {
            // If the quiz hasn't been saved yet, just clear the local property
            _quiz.ImagePath = null;
            _selectedImageFile = null;
        }
        else
        {
            // If the quiz has been saved, call the API to remove the image
            var result = await QuizImageService.RemoveQuizImageAsync(_quiz.Id);
            if (result.IsSuccess)
            {
                _quiz.ImagePath = null;
            }
            else
            {
                await ShowAlertAsync("Failed to remove image: " + result.ErrorMessage);
            }
        }
    }

    private void OnImageFileChanged(IBrowserFile file)
    {
        _selectedImageFile = file;
    }

    private IBrowserFile? GetQuestionImageFile(QuestionDto question)
    {
        if (_questionImageFiles.ContainsKey(question))
        {
            return _questionImageFiles[question];
        }
        return null;
    }

    private IBrowserFile? GetQuestionAudioFile(QuestionDto question)
    {
        if (_questionAudioFiles.ContainsKey(question))
        {
            return _questionAudioFiles[question];
        }
        return null;
    }

    private async Task OnQuestionImageFileChanged(QuestionDto question, IBrowserFile file)
    {
        _questionImageFiles[question] = file;
        StateHasChanged();
    }

    private async Task RemoveQuestionImageAsync(QuestionDto question)
    {
        if (question.Id == 0) // New question, not saved yet
        {
            question.ImagePath = null;
            if (_questionImageFiles.ContainsKey(question))
            {
                _questionImageFiles.Remove(question);
            }
        }
        else // Saved question
        {
            var result = await QuestionImageService.RemoveQuestionImageAsync(question.Id);
            if (result.IsSuccess)
            {
                question.ImagePath = null;
            }
            else
            {
                await ShowAlertAsync("Failed to remove image: " + result.ErrorMessage);
            }
        }
    }

    private async Task RemoveQuestionAudioAsync(QuestionDto question)
    {
        if (question.Id == 0) // New question, not saved yet
        {
            question.AudioPath = null;
            if (_questionAudioFiles.ContainsKey(question))
            {
                _questionAudioFiles.Remove(question);
            }
        }
        else // Saved question
        {
            var result = await QuestionAudioService.RemoveQuestionAudioAsync(question.Id);
            if (result.IsSuccess)
            {
                question.AudioPath = null;
            }
            else
            {
                await ShowAlertAsync("Failed to remove audio: " + result.ErrorMessage);
            }
        }
    }

    private void AddOptionToQuestion(QuestionDto question)
    {
        question.Options.Add(new OptionDto());
    }

    private void OnQuestionTypeChanged(QuestionDto question)
    {
        if (question.IsTextAnswer)
        {
            // Clear options when switching to text answer
            question.Options.Clear();
        }
        else
        {
            // Clear text answers when switching to multiple choice
            question.TextAnswers.Clear();
        }
    }

    private Dictionary<QuestionDto, IBrowserFile?> _questionImageFiles = new();
    private Dictionary<QuestionDto, IBrowserFile?> _questionAudioFiles = new();

    private void GoToCard(int index)
    {
        CurrentCardIndex = index;
    }

    private void GoToPrevCard()
    {
        if (CurrentCardIndex > 0)
            CurrentCardIndex--;
    }

    private void GoToNextCard()
    {
        if (CurrentCardIndex < TotalCards - 1)
            CurrentCardIndex++;
    }
}