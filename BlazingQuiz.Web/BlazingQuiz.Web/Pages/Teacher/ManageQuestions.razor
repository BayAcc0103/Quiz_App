@page "/teacher/manage-questions"

@using BlazingQuiz.Shared
@using BlazingQuiz.Shared.Components.Components
@using BlazingQuiz.Shared.Components
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using System.Security.Claims
@using System.Linq
@attribute [Authorize(Roles = nameof(UserRole.Teacher))]

@inject IQuizApi QuizApi
@inject IAppState AppState
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="container">
    <!-- Hanging container with 2 ropes -->
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- Hanging container with 2 ropes -->
            <div class="hanging-container">
                <div class="hanging-content">
                    <h3>Manage Questions</h3>
                </div>
                <!-- Ropes connecting hanging container to main card -->
                <div class="rope left-rope"></div>
                <div class="rope right-rope"></div>
            </div>
        </div>
    </div>
    <BackButton />

    <!-- Top section: Search and Filters -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div class="d-flex flex-column align-items-start gap-3">
                <!-- Search input - centered -->
                <div class="position-relative w-50">
                    <input type="text"
                           class="form-control ps-4"
                           placeholder="Search questions by text..."
                           @bind="_searchTerm"
                           @bind:event="oninput" />
                    <span class="position-absolute start-0 top-50 translate-middle-y ms-2">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    @if (!string.IsNullOrEmpty(_searchTerm))
                    {
                        <button class="position-absolute end-0 top-50 translate-middle-y me-2 btn btn-link p-0 text-decoration-none"
                                type="button"
                                style="border: none; background: none; color: #6c757d;"
                                @onclick="() => { _searchTerm = string.Empty; }">
                            <i class="fas fa-times"></i>
                        </button>
                    }
                </div>
            </div>
            <div>
                <a href="/teacher/add-question" class="btn btn-3d btn-3d-primary">
                    <i class="fas fa-plus me-2"></i>Add Question
                </a>
            </div>
        </div>
    </div>

    <!-- Bottom section: Questions table -->
    <div class="row">
        <div class="col-12">
            <h3>My Questions</h3>
            @if(_filteredQuestions.Length == 0)
            {
                <div class="text-center">
                    @if (!string.IsNullOrEmpty(_searchTerm))
                    {
                        <p class="text-danger h5">No questions found matching "@_searchTerm"</p>
                    }
                    else
                    {
                        <p class="text-danger h5">No questions available</p>
                    }
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Question</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var question in _filteredQuestions)
                            {
                                <tr>
                                    <td>@question.Text</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-3d btn-3d-info btn-sm" @onclick="() => ViewQuestionDetails(question)">View</button>
                                            <button type="button" class="btn btn-3d btn-3d-primary btn-sm" @onclick="() => EditQuestion(question)">Edit</button>
                                            <button type="button" class="btn btn-3d btn-3d-danger btn-sm" @onclick="() => DeleteQuestion(question)">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@if (_showQuestionModal)
{
    <Modal Title="Question Details"
           Size="ModalSize.Large"
           ActionButtonText="Close"
           OnActionButtonClick="() => _showQuestionModal = false"
           OnCancelClick="() => _showQuestionModal = false">
        @if (_selectedQuestion != null)
        {
            <div class="question-details-container">
                <div class="question-text mb-3">
                    <h5>Question:</h5>
                    <p class="mb-2">@_selectedQuestion.Text</p>
                </div>

                <div class="options-container">
                    <h6>Options:</h6>
                    <div class="options-list">
                        @if (_selectedQuestion.IsTextAnswer)
                        {
                            <div class="text-answer-section">
                                <p><strong>Expected Text Answer:</strong></p>
                                @if (_selectedQuestion.TextAnswers != null && _selectedQuestion.TextAnswers.Any())
                                {
                                    @foreach (var textAnswer in _selectedQuestion.TextAnswers.Where(ta => ta != null))
                                    {
                                        <div class="text-answer-item mb-2 p-2 bg-light rounded">
                                            <span class="badge bg-info">Sample Answer</span>
                                            <p class="mb-0">@textAnswer.Text</p>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted">No sample answers provided</p>
                                }
                            </div>
                        }
                        else
                        {
                            @if (_selectedQuestion.Options != null && _selectedQuestion.Options.Any())
                            {
                                @foreach (var option in _selectedQuestion.Options.Where(o => o != null))
                                {
                                    <div class="option-item mb-2 p-2 @(option.IsCorrect ? "bg-success bg-opacity-10 border border-success rounded" : "bg-light rounded")">
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">@(option.IsCorrect ? "✓" : "○")</span>
                                            <span class="flex-grow-1">@option.Text</span>
                                            @if (option.IsCorrect)
                                            {
                                                <span class="badge bg-success ms-2">Correct</span>
                                            }
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <p class="text-muted">No options available</p>
                            }
                        }
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(_selectedQuestion.AnswerExplanation))
                {
                    <div class="explanation-container mt-3 p-2 bg-info bg-opacity-10 border border-info rounded">
                        <h6>Explanation:</h6>
                        <p class="mb-0">@_selectedQuestion.AnswerExplanation</p>
                    </div>
                }

                <div class="mt-3">
                    <h6>Quiz Information:</h6>
                    <p>Quiz information not available</p>
                </div>
            </div>
        }
    </Modal>
}

@if (_showDeleteConfirmation)
{
    <Modal Title="Confirm Deletion"
           OnActionButtonClick="ExecuteDeleteQuestion"
           OnCancelClick="() => _showDeleteConfirmation = false"
           ActionButtonText="Delete"
           CancelText="Cancel">
        <p>Are you sure you want to delete this question?</p>
        <p class="text-muted">Question: @_questionToDelete?.Text</p>
    </Modal>
}

@code {
    private QuestionDto[] _allQuestions = [];
    private QuestionDto[] _filteredQuestions = [];
    private string _searchTerm = string.Empty;
    private QuestionDto? _selectedQuestion;
    private bool _showQuestionModal = false;
    private bool _showDeleteConfirmation = false;
    private QuestionDto? _questionToDelete;
    private int CurrentUserId = 0;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        CurrentUserId = int.TryParse(userIdClaim, out var userId) ? userId : 0;

        await LoadQuestionsAsync();
    }

    private async Task LoadQuestionsAsync()
    {
        AppState.ShowLoader("Loading questions...");
        try
        {
            // Get questions created by the current user
            var response = await QuizApi.GetQuestionsCreatedByAsync(CurrentUserId);
            if (response.IsSuccess && response.Data != null)
            {
                _allQuestions = response.Data;
                _filteredQuestions = _allQuestions;
                ApplyFilters();
            }
            else
            {
                AppState.ShowError(response.ErrorMessage ?? "Failed to load questions");
            }
        }
        catch (Exception ex)
        {
            AppState.ShowError($"Error loading questions: {ex.Message}");
        }
        finally
        {
            AppState.HideLoader();
        }
    }

    private void ApplyFilters()
    {
        var result = _allQuestions.AsEnumerable();

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(_searchTerm))
        {
            result = result.Where(q => q.Text.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        _filteredQuestions = result.ToArray();
    }

    private void OnSearchChanged()
    {
        ApplyFilters();
    }

    private void ViewQuestionDetails(QuestionDto question)
    {
        _selectedQuestion = question;
        _showQuestionModal = true;
    }

    private void EditQuestion(QuestionDto question)
    {
        // Navigate to edit question page (to be implemented)
        // For now, just show a message
        AppState.ShowAlert("Edit functionality to be implemented", AlertType.Info);
    }

    private void DeleteQuestion(QuestionDto question)
    {
        _questionToDelete = question;
        _showDeleteConfirmation = true;
    }

    private async Task ExecuteDeleteQuestion()
    {
        if (_questionToDelete != null)
        {
            _showDeleteConfirmation = false;
            AppState.ShowLoader("Deleting question...");
            try
            {
                var response = await QuizApi.DeleteQuestionAsync(_questionToDelete.Id);
                if (response.IsSuccess)
                {
                    AppState.ShowAlert("Question deleted successfully", AlertType.Success);
                }
                else
                {
                    AppState.ShowError(response.ErrorMessage ?? "Failed to delete question");
                }

                // Reload questions after deletion
                await LoadQuestionsAsync();
            }
            catch (Exception ex)
            {
                AppState.ShowError($"Error deleting question: {ex.Message}");
            }
            finally
            {
                AppState.HideLoader();
                _questionToDelete = null;
            }
        }
    }
}