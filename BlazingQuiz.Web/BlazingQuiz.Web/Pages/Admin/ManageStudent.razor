@page "/admin/manage-students"
@using BlazingQuiz.Shared
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using System.Linq
@attribute [Authorize(Roles = nameof(UserRole.Admin))]

@inject IAdminApi UserApi
@inject UserAvatarService UserAvatarService
@inject IAppState AppState
@inject IJSRuntime JSRuntime
@inject HttpClient HttpClient

<div class="container">
    <!-- Hanging container with 2 ropes -->
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- Hanging container with 2 ropes -->
            <div class="hanging-container">
                <div class="hanging-content">
                    <h3>Manage Users</h3>
                </div>
                <!-- Ropes connecting hanging container to main card -->
                <div class="rope left-rope"></div>
                <div class="rope right-rope"></div>
            </div>
        </div>
    </div>
    <BackButton />
    <!-- Top section: Search and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column align-items-center gap-3">
                <!-- Search input - centered -->
                <div class="position-relative w-50">
                    <input type="text"
                           class="form-control ps-4"
                           placeholder="Search students by name..."
                           @bind="_searchTerm"
                           @bind:event="oninput" />
                    <span class="position-absolute start-0 top-50 translate-middle-y ms-2">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    @if (!string.IsNullOrEmpty(_searchTerm))
                    {
                        <button class="position-absolute end-0 top-50 translate-middle-y me-2 btn btn-link p-0 text-decoration-none"
                                type="button"
                                style="border: none; background: none; color: #6c757d;"
                                @onclick="() => { _searchTerm = string.Empty; }">
                            <i class="fas fa-times"></i>
                        </button>
                    }
                </div>

                <!-- Two filters in one row - side by side with equal width -->
                <div class="d-flex flex-wrap justify-content-center gap-4 w-100">
                    <!-- Filter dropdown - approval status -->
                    <div class="d-flex flex-column align-items-center flex-fill" style="min-width: 200px;">
                        <label class="form-label">Filter by approval status:</label>
                        <select class="form-select form-control" @onchange="OnFilterChanged">
                            <option value="">Show all users</option>
                            <option value="true">Show approved users only</option>
                            <option value="false">Show unapproved users only</option>
                        </select>
                    </div>

                    <!-- Role filter - side by approval filter -->
                    <div class="d-flex flex-column align-items-center flex-fill" style="min-width: 200px;">
                        <label class="form-label">Filter by role:</label>
                        <select class="form-select form-control" @onchange="OnRoleFilterChanged">
                            <option value="">All roles</option>
                            <option value="Student">Student</option>
                            <option value="Teacher">Teacher</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom section: Students grid -->
    <div class="row">
        <div class="col-12">
            <h3>Users</h3>
            @if(_users.Length == 0)
            {
                <div class="text-center">
                    <p class="text-danger h5">No users available</p>
                </div>
            }
            else
            {
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3">
                    @foreach (var user in FilteredUsers)
                    {
                        <div class="col">
                            <div class="card h-100 user-card user-card-3d">
                                <div class="avatar-container position-relative">
                                    @if (!string.IsNullOrEmpty(user.AvatarPath))
                                    {
                                        <img src="@GetUserAvatarUrl(user.AvatarPath)"
                                             class="user-avatar"
                                             alt="@user.Name" />
                                    }
                                    else
                                    {
                                        <div class="user-placeholder d-flex align-items-center justify-content-center">
                                            <span class="text-muted">@GetInitials(user.Name)</span>
                                        </div>
                                    }
                                    <div class="avatar-overlay">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                   id="approvedToggle_@user.Id"
                                                   checked="@user.IsApproved"
                                                   @onchange="async (e) => await ToggleIsApproved(user, e.Value)" />
                                            <label class="form-check-label" for="approvedToggle_@user.Id">
                                                @(user.IsApproved ? "Approved" : "Pending")
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body d-flex flex-column position-relative">
                                    <h5 class="card-title text-center">@user.Name</h5>
                                    <div class="card-button-overlay">
                                        <button type="button" class="btn btn-3d btn-3d-primary btn-sm card-action-btn" @onclick="() => ViewUserDetails(user)">
                                            View Details
                                        </button>
                                    </div>
                                </div>
                            </div>
                            </div>
                 
                    }
                </div>

                @if (FilteredUsers.Length == 0 && !string.IsNullOrEmpty(_searchTerm))
                {
                    <div class="text-center mt-4">
                        <p class="text-muted">No users found matching "@_searchTerm"</p>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    private UserDto[] _users = [];
    private bool _isBusy;
    private string? _errorMessage;
    private string _searchTerm = string.Empty;
    private string? _approvalFilter = null; // null = all, "true" = approved, "false" = not approved
    private string? _roleFilter = null; // null = all, or specific role

    private UserDto[] FilteredUsers
    {
        get
        {
            var result = _users.AsEnumerable();

            // Apply search filter
            if (!string.IsNullOrWhiteSpace(_searchTerm))
            {
                result = result.Where(c =>
                    c.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase));
            }

            // Apply approval status filter
            if (!string.IsNullOrEmpty(_approvalFilter))
            {
                if (_approvalFilter == "true") // Show approved students only
                {
                    result = result.Where(c => c.IsApproved);
                }
                else if (_approvalFilter == "false") // Show unapproved students only
                {
                    result = result.Where(c => !c.IsApproved);
                }
            }

            // Apply role filter
            if (!string.IsNullOrEmpty(_roleFilter))
            {
                result = result.Where(c => c.Role == _roleFilter);
            }

            return result.ToArray();
        }
    }

    private void OnFilterChanged(ChangeEventArgs e)
    {
        _approvalFilter = e.Value?.ToString();
    }

    private void OnRoleFilterChanged(ChangeEventArgs e)
    {
        _roleFilter = e.Value?.ToString();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadUsersAsync();
    }

    private async Task LoadUsersAsync()
    {
        AppState.ShowLoader("Loading students...");
        _users = (await UserApi.GetUsersAsync(UserApprovedFilter.All, 0, 1000)).Records; // Get all users
        AppState.HideLoader();
    }

    private async Task ToggleIsApproved(UserDto user, object? value)
    {
        if (value is bool isApproved)
        {
            try
            {
                _isBusy = true;
                AppState.ShowLoader("Updating student approval status...");

                // Save the updated user approval status
                await UserApi.ToggleUserApprovedStatusAsync(user.Id);

                // Update the local copy after successful API call
                user.IsApproved = isApproved;
            }
            catch (Exception ex)
            {
                _errorMessage = $"Error updating student approval status: {ex.Message}";
                // Revert the change if there's an exception
                user.IsApproved = !isApproved;
            }
            finally
            {
                _isBusy = false;
                AppState.HideLoader();
                StateHasChanged();
            }
        }
    }

    private string GetInitials(string fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName))
            return "?";

        var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[parts.Length - 1][0]}".ToUpper();
        }
        else if (parts.Length == 1)
        {
            return $"{parts[0][0]}".ToUpper();
        }
        else
        {
            return "?";
        }
    }

    private string GetUserAvatarUrl(string imagePath)
    {
        if (string.IsNullOrEmpty(imagePath))
            return string.Empty;

        // Construct the full URL using HttpClient BaseAddress
        if (HttpClient.BaseAddress != null)
        {
            var baseUrl = HttpClient.BaseAddress.ToString().TrimEnd('/');
            return $"{baseUrl}/{imagePath}";
        }
        else
        {
            // Fallback if BaseAddress is null
            return $"https://localhost:7048/{imagePath}";
        }
    }

    private async Task ViewUserDetails(UserDto user)
    {
        // For now, just show an alert with user details
        await JSRuntime.InvokeVoidAsync("alert",
            $"User Details:\nName: {user.Name}\nEmail: {user.Email}\nPhone: {user.Phone}\nRole: {user.Role}\nApproved: {(user.IsApproved ? "Yes" : "No")}");
    }
}
