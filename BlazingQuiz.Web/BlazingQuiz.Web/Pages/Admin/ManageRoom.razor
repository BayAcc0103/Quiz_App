@page "/admin/rooms"
@using BlazingQuiz.Shared.DTOs
@using BlazingQuiz.Web.Services
@inject IRoomApi RoomApi
@inject IStorageService LocalStorage
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Manage Rooms - Admin</PageTitle>

<div class="container">
    <!-- Hanging container with 2 ropes -->
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- Hanging container with 2 ropes -->
            <div class="hanging-container">
                <div class="hanging-content">
                    <h3>Manage Rooms</h3>
                </div>
                <!-- Ropes connecting hanging container to main card -->
                <div class="rope left-rope"></div>
                <div class="rope right-rope"></div>
            </div>
        </div>
    </div>

    <BackButton />
    <!-- Search section: Similar to category management page -->
    <div class="row mb-3 mt-4">
        <div class="col-12">
            <div class="position-relative">
                <input type="text"
                       class="form-control ps-4"
                       placeholder="Search rooms by name or code..."
                       @bind="_searchTerm"
                       @bind:event="oninput" />
                <span class="position-absolute start-0 top-50 translate-middle-y ms-2">
                    <i class="fas fa-search text-muted"></i>
                </span>
                @if (!string.IsNullOrEmpty(_searchTerm))
                {
                    <button class="position-absolute end-0 top-50 translate-middle-y me-2 btn btn-link p-0 text-decoration-none"
                            type="button"
                            style="border: none; background: none; color: #6c757d;"
                            @onclick="() => { _searchTerm = string.Empty; }">
                        <i class="fas fa-times"></i>
                    </button>
                }
            </div>
        </div>
    </div>
    <!-- Top section: Refresh button and page size selector -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div class="mb-2 mb-md-0">
                    <label for="pageSize" class="form-label mb-0">Items per page:</label>
                    <select id="pageSize" class="form-select ms-2" style="display: inline-block; width: auto;" @onchange="OnPageSizeChanged">
                        <option value="9">9</option>
                        <option value="12">12</option>
                        <option value="18">18</option>
                        <option value="24">24</option>
                    </select>
                </div>
                <button class="btn btn-3d btn-3d-primary" @onclick="RefreshRooms" disabled="@isDeleting">
                    <span class="bi bi-arrow-repeat"></span> Refresh
                </button>
            </div>
        </div>
    </div>
    <!-- Bottom section: Room grid -->
    <div class="row">
        <div class="col-12">
            <h3>Rooms (@totalRooms)</h3>
            @{
                var filteredRooms = FilterRooms();
                var paginatedRooms = PaginateRooms(filteredRooms);
            }

            @if(filteredRooms == null || !filteredRooms.Any())
            {
                <div class="text-center">
                    <p class="text-danger h5">@(!string.IsNullOrEmpty(_searchTerm) ? "No rooms found" : "No rooms available")</p>
                    @if (isLoading == false && string.IsNullOrEmpty(_searchTerm))
                    {
                        <p class="mb-0">Currently there are no rooms in the system.</p>
                    }
                </div>
            }
            else
            {
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3">
                    @foreach (var room in paginatedRooms)
                    {
                        <div class="col">
                            <div class="card h-100 room-card room-card-3d" title="@room.Name">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title text-center">@room.Name</h5>
                                    <div class="room-details mb-2">
                                        <p class="mb-1"><strong>Code:</strong> @room.Code</p>
                                        <p class="mb-1"><strong>Created By:</strong> @room.CreatedByName</p>
                                        <p class="mb-1"><strong>Status:</strong>
                                            <span class="@(room.IsActive ? "text-success" : "text-secondary")">
                                                @(room.IsActive ? "Active" : "Inactive")
                                            </span>
                                        </p>
                                    </div>
                                    <div class="mt-auto d-flex justify-content-center">
                                        <button type="button" class="btn-room-action" @onclick="() => ViewDetails(room.Id)" disabled="@isDeleting" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn-room-action btn-room-action-danger" @onclick="() => DeleteRoom(room.Id)" disabled="@isDeleting" title="Delete Room">
                                            @if (isDeleting)
                                            {
                                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-trash"></i>
                                            }
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                @if (rooms != null && rooms.Any() && isLoading)
                {
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(_searchTerm) && filteredRooms.Any() == false)
                {
                    <div class="text-center mt-4">
                        <p class="text-muted">No rooms found matching "@_searchTerm"</p>
                    </div>
                }

                <!-- Pagination controls -->
                @if (filteredRooms != null && filteredRooms.Any() && filteredRooms.Count > pageSize)
                {
                    <nav aria-label="Room pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                <button class="page-link" @onclick="() => GoToPage(1)" disabled="@(currentPage == 1)">First</button>
                            </li>
                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">Previous</button>
                            </li>

                            @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                            {
                                <li class="page-item @(i == currentPage ? "active" : "")">
                                    <button class="page-link" @onclick="() => GoToPage(i)">@i</button>
                                </li>
                            }

                            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)">Next</button>
                            </li>
                            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                <button class="page-link" @onclick="() => GoToPage(totalPages)" disabled="@(currentPage == totalPages)">Last</button>
                            </li>
                        </ul>
                    </nav>

                    <div class="d-flex justify-content-center mt-2">
                        <p class="text-muted">
                            Page @currentPage of @totalPages (@totalRooms total rooms)
                        </p>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    private List<RoomDto>? rooms;
    private bool isLoading = true;
    private bool isDeleting = false;
    private string _searchTerm = string.Empty;

    // Pagination properties
    private int currentPage = 1;
    private int pageSize = 12; // Default page size
    private int totalRooms = 0;
    private int totalPages = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadRooms();
    }

    private async Task LoadRooms()
    {
        try
        {
            isLoading = true;
            rooms = (await RoomApi.GetRoomsForAdminAsync())?.ToList() ?? new List<RoomDto>();
            totalRooms = rooms?.Count ?? 0;
            totalPages = (int)Math.Ceiling((double)totalRooms / pageSize);

            // Reset to first page when loading new data
            if (currentPage > totalPages && totalPages > 0)
            {
                currentPage = totalPages;
            }
            else if (totalPages == 0)
            {
                currentPage = 1;
            }
        }
        catch (Exception ex)
        {
            // Log error or show notification
            Console.WriteLine($"Error loading rooms: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private List<RoomDto>? FilterRooms()
    {
        if (rooms == null)
            return null;

        if (string.IsNullOrWhiteSpace(_searchTerm))
            return rooms;

        var searchTermLower = _searchTerm.ToLowerInvariant();
        var filtered = rooms.Where(r =>
            r.Name.ToLowerInvariant().Contains(searchTermLower) ||
            r.Code.ToLowerInvariant().Contains(searchTermLower) ||
            r.CreatedByName.ToLowerInvariant().Contains(searchTermLower)
        ).ToList();

        // Update total count after filtering
        totalRooms = filtered.Count;
        totalPages = (int)Math.Ceiling((double)totalRooms / pageSize);

        return filtered;
    }

    private List<RoomDto> PaginateRooms(List<RoomDto>? filteredRooms)
    {
        if (filteredRooms == null || !filteredRooms.Any())
            return new List<RoomDto>();

        // Calculate total pages based on filtered results
        totalPages = (int)Math.Ceiling((double)filteredRooms.Count / pageSize);

        // Ensure current page is within valid range
        if (currentPage > totalPages && totalPages > 0)
        {
            currentPage = totalPages;
        }
        else if (totalPages == 0)
        {
            currentPage = 1;
        }

        // Calculate start index and take the appropriate page
        int startIndex = (currentPage - 1) * pageSize;
        return filteredRooms.Skip(startIndex).Take(pageSize).ToList();
    }

    private void GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
        }
    }

    private void OnPageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newSize))
        {
            pageSize = newSize;
            currentPage = 1; // Reset to first page when page size changes
        }
    }

    private async Task ViewDetails(Guid roomId)
    {
        Navigation.NavigateTo($"/admin/rooms/{roomId}");
    }

    private async Task DeleteRoom(Guid roomId)
    {
        bool confirmed = await ConfirmDelete();
        if (!confirmed)
        {
            return; // User cancelled the deletion
        }

        try
        {
            isDeleting = true;

            var response = await RoomApi.DeleteRoomAsync(roomId);
            if (response.IsSuccessStatusCode)
            {
                // Reload rooms to reflect the deletion
                await LoadRooms();
            }
            else
            {
                Console.WriteLine($"Error deleting room: {response.Error}");
                // You might want to show an error message to the user
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting room: {ex.Message}");
            // You might want to show an error message to the user
        }
        finally
        {
            isDeleting = false;
        }
    }

    private async Task RefreshRooms()
    {
        currentPage = 1; // Reset to first page when refreshing
        await LoadRooms();
    }

    private async Task<bool> ConfirmDelete()
    {
        return await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this room? This will also delete all participants and answers associated with this room.");
    }
}