@page "/student/flashcard-quiz"
@using BlazingQuiz.Shared.DTOs
@using BlazingQuiz.Shared.Components.Components
@using BlazingQuiz.Web.Apis

@layout QuizPageLayout
@inject NavigationManager NavigationManager
@inject QuizState QuizState
@inject BlazingQuiz.Web.Apis.IStudentQuizApi StudentQuizApi
@inject IAppState AppState
@inject QuestionImageService QuestionImageService
@inject QuestionAudioService QuestionAudioService

@if(QuizState.Quiz != null)
{
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Hanging element showing the quiz name -->
                <div class="d-flex justify-content-center">
                    <div class="hanging-quiz-info hanging-quiz-title">
                        <div class="hanging-content">
                            <h3 class="mb-0">@QuizState.Quiz.Name</h3>
                        </div>
                        <div class="rope left-rope"></div>
                        <div class="rope right-rope"></div>
                    </div>
                </div>

                <!-- Progress counter with hanging elements -->
                <div class="d-flex justify-content-center">
                    <div class="progress-hanging-container">
                        <!-- Current question count -->
                        <div class="hanging-quiz-info hanging-question-current me-2">
                            <div class="hanging-content">
                                <h6 class="mb-0">@(_currentIndex + 1)</h6>
                            </div>
                            <div class="rope left-rope"></div>
                            <div class="rope right-rope"></div>
                        </div>

                        <!-- Separator -->
                        <div class="hanging-quiz-info hanging-separator mx-2">
                            <div class="hanging-content">
                                <h6 class="mb-0">/</h6>
                            </div>
                            <div class="rope left-rope"></div>
                            <div class="rope right-rope"></div>
                        </div>

                        <!-- Total questions -->
                        <div class="hanging-quiz-info hanging-question-total ms-2">
                            <div class="hanging-content">
                                <h6 class="mb-0">@_questions.Count</h6>
                            </div>
                            <div class="rope left-rope"></div>
                            <div class="rope right-rope"></div>
                        </div>
                    </div>
                </div>

                @if (_questions.Any())
                {
                    @if (_isPageReady)
                    {
                        <div class="flashcard-container">
                            <div class="flip-card-container">
                                <div class="flip-card @(IsFlipped ? "flipped" : "")" id="flip-card-@_currentIndex">
                                    <div class="card-face card-front">
                                        <div class="card-content-question">
                                            <!-- Question Image -->
                                            @if (!string.IsNullOrEmpty(_currentQuestion.ImagePath))
                                            {
                                                <div class="question-image-container mb-3">
                                                    <img src="@QuestionImageService.GetImageUrl(_currentQuestion.ImagePath)" alt="Question Image" class="img-fluid" />
                                                </div>
                                            }

                                            <!-- Question Audio -->
                                            @if (!string.IsNullOrEmpty(_currentQuestion.AudioPath))
                                            {
                                                <div class="question-audio-container mb-3">
                                                    @if (_currentQuestion.AudioPath.EndsWith(".mp3", StringComparison.OrdinalIgnoreCase))
                                                    {
                                                        <audio controls class="w-100">
                                                            <source src="@QuestionAudioService.GetAudioUrl(_currentQuestion.AudioPath)" type="audio/mpeg" />
                                                            Your browser does not support the audio element.
                                                        </audio>
                                                    }
                                                    else
                                                    {
                                                        <div class="alert alert-info card-3d-raised">Audio file available: @_currentQuestion.AudioPath</div>
                                                    }
                                                </div>
                                            }

                                            <!-- Question Text -->
                                            <h5 class="card-question">@_currentQuestion.Text</h5>

                                            @if (!_currentQuestion.IsTextAnswer && _currentQuestion.Options.Any())
                                            {
                                                <div class="card-options mt-3">
                                                    @foreach (var option in _currentQuestion.Options)
                                                    {
                                                        <div class="card-option">@option.Text</div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        <div class="card-hint flip-indicator">
                                            <i class="bi bi-arrow-repeat"></i> Click card or button to flip
                                        </div>
                                    </div>
                                    <div class="card-face card-back">
                                        <div class="card-content-answer">
                                            <h5 class="card-question">Answer</h5>
                                            @if (_currentQuestion.IsTextAnswer)
                                            {
                                                <div class="card-answer mt-3">
                                                    @if (_currentQuestion.TextAnswers != null && _currentQuestion.TextAnswers.Any())
                                                    {
                                                        @foreach (var textAnswer in _currentQuestion.TextAnswers)
                                                        {
                                                            <div class="flashcard-text-answer">@textAnswer.Text</div>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <div class="flashcard-text-answer">No answer provided</div>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="card-options">
                                                    @foreach (var option in _currentQuestion.Options.Where(o => o.IsCorrect))
                                                    {
                                                        <div class="card-option correct">@option.Text</div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        <div class="card-hint">
                                            <i class="bi bi-arrow-repeat"></i> Click to flip back
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }

                    <div class="flashcard-navigation mt-3">
                        <button class="flashcard-button flash-card-prev-btn"
                                @onclick="PreviousQuestion"
                                disabled="@(_currentIndex == 0)">
                            <i class="bi bi-arrow-left me-1"></i> Previous
                        </button>

                        <button class="flashcard-button flash-card-flip-btn"
                                @onclick="ToggleFlip">
                            <i class="bi bi-arrow-repeat me-1"></i> @_flipButtonText
                        </button>

                        @if (_currentIndex == _questions.Count - 1)
                        {
                            <button class="flashcard-button flash-card-submit-btn"
                                    @onclick="SubmitQuizAsync">
                                Submit Quiz <i class="bi bi-check2-all ms-1"></i>
                            </button>
                        }
                        else
                        {
                            <button class="flashcard-button flash-card-next-btn"
                                    @onclick="NextQuestion">
                                Next <i class="bi bi-arrow-right ms-1"></i>
                            </button>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}
else
{
    <div class="text-center mt-5">
        <h3>No Quiz Selected</h3>
        <p>You must start a quiz first from the 'My Quizzes' page.</p>
        <div class="mt-4">
            <a href="/student/home" class="btn btn-primary me-2">Go to Home</a>
            <a href="/student/my-quizes" class="btn btn-secondary">My Quizzes</a>
        </div>
    </div>
}

@if (_submitQuizMessage != null)
{
    <Modal Title="Quiz Submitted" OnActionButtonClick="RedirectToMyQuizes" OnCancelClick="RedirectToMyQuizes">
        <p class="text-success h5">@_submitQuizMessage</p>
    </Modal>
}


<script>
    // Custom JavaScript for enhanced flip card interactions
    window.quizHelpers = {
        // Function to add special effects when flipping cards
        addFlipEffect: function(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.addEventListener('transitionend', function() {
                    console.log('Flip animation completed');
                });
            }
        },
        
        // Function to play sound effect on flip (if needed)
        playFlipSound: function() {
            // In a real implementation, you could play a sound here
        },
        
        // Function to add keyboard navigation support
        setupKeyboardNavigation: function() {
            document.addEventListener('keydown', function(event) {
                // Add keyboard support for navigation
                if (event.key === 'ArrowLeft') {
                    // Previous button action
                    document.querySelector('.flash-card-prev-btn')?.click();
                } else if (event.key === 'ArrowRight') {
                    // Next button action
                    document.querySelector('.flash-card-next-btn')?.click();
                } else if (event.key === ' ' || event.key === 'Enter') {
                    // Spacebar or Enter to flip card
                    event.preventDefault(); // Prevent page scroll
                    document.querySelector('.flash-card-flip-btn')?.click();
                }
            });
        },
        
        // Function to focus on the active flashcard for accessibility
        focusOnFlashcard: function(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                setTimeout(() => {
                    element.focus();
                    element.setAttribute('tabindex', '0');
                }, 100);
            }
        },
        
        // Function to initialize flip card behavior
        initializeFlipCard: function(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                // Add click event to flip the card
                card.addEventListener('click', function(e) {
                    // Only flip if clicked on the card itself, not on interactive elements
                    if (e.target === card || e.target.classList.contains('card-face') || 
                        e.target.classList.contains('card-front') || e.target.classList.contains('card-back')) {
                        // Trigger the flip button click
                        document.querySelector('.flash-card-flip-btn')?.click();
                    }
                });
            }
        }
    };
    
    // Initialize keyboard navigation when page loads
    window.quizHelpers.setupKeyboardNavigation();
    
    // Enhanced flip animation with 3D effect
    window.flipCard = function(cardId) {
        const card = document.getElementById(cardId);
        if (card) {
            card.classList.toggle('flipped');
        }
    };
    
    // Reset card to front position
    window.resetCard = function(cardId) {
        const card = document.getElementById(cardId);
        if (card && card.classList.contains('flipped')) {
            card.classList.remove('flipped');
        }
    };
</script>

@code {
    private List<QuestionDto> _questions = new();
    private QuestionDto _currentQuestion = new();
    private int _currentIndex = 0;
    private bool _isFlipped = false;
    private string _flipButtonText = "Flip Card";
    private string? _errorMessage;
    private string? _submitQuizMessage;
    private bool _isPageReady = false;

    protected override async Task OnInitializedAsync()
    {
        if(QuizState.Quiz == null || QuizState.StudentQuizId == 0)
        {
            NavigationManager.NavigateTo("student/home", replace: true);
            return;
        }
        
        AppState.ShowLoader("Loading questions...");
        try
        {
            // Load all questions for the quiz
            var allQuestionsResult = await StudentQuizApi.GetAllQuestionsForQuizAsync(QuizState.StudentQuizId);
            if (allQuestionsResult.IsSuccess && allQuestionsResult.Data != null)
            {
                _questions = allQuestionsResult.Data.ToList();
                if (_questions.Any())
                {
                    _currentQuestion = _questions[_currentIndex];
                }
                else
                {
                    _errorMessage = "No questions available for this quiz";
                }
            }
            else
            {
                _errorMessage = allQuestionsResult.ErrorMessage ?? "Failed to load questions";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            AppState.HideLoader();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Wait a brief moment to ensure CSS is loaded before showing the flashcard
            await Task.Delay(50);
            _isPageReady = true;
            StateHasChanged();
        }
    }
    
    private bool IsFlipped => _isFlipped;

    private async Task NextQuestion()
    {
        if (_currentIndex < _questions.Count - 1)
        {
            _currentIndex++;
            _currentQuestion = _questions[_currentIndex];
            _isFlipped = false; // Reset flip state when moving to next question
            _flipButtonText = "Flip Card";
        }
    }

    private async Task PreviousQuestion()
    {
        if (_currentIndex > 0)
        {
            _currentIndex--;
            _currentQuestion = _questions[_currentIndex];
            _isFlipped = false; // Reset flip state when moving to previous question
            _flipButtonText = "Flip Card";
        }
    }

    private async Task ToggleFlip()
    {
        _isFlipped = !_isFlipped;
        _flipButtonText = _isFlipped ? "Flip Back" : "Flip Card";
    }

    private async Task OnFlipChanged(bool isFlipped)
    {
        _isFlipped = isFlipped;
        _flipButtonText = _isFlipped ? "Flip Back" : "Flip Card";
    }

    private async Task OnCardFlipped()
    {
        // Optional: Add any additional logic when card is flipped
    }

    private async Task SubmitQuizAsync()
    {
        try
        {
            AppState.ShowLoader("Submitting quiz...");
            QuizApiResponse result = await StudentQuizApi.SubmitQuizAsync(QuizState.StudentQuizId);
            if(!result.IsSuccess)
            {
                _errorMessage = result.ErrorMessage;
                return;
            }
            
            _submitQuizMessage = "Quiz submitted successfully";
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            AppState.HideLoader();
        }
    }

    private async Task AutoSubmitQuizAsync()
    {
        try
        {
            AppState.ShowLoader("Auto submitting the quiz");
            QuizApiResponse result = await StudentQuizApi.AutoSubmitQuizAsync(QuizState.StudentQuizId);
            if(!result.IsSuccess)
            {
                _errorMessage = result.ErrorMessage;
                return;
            }
            
            _submitQuizMessage = "Quiz submitted successfully";
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            AppState.HideLoader();
        }
    }

    private void RedirectToMyQuizes()
    {
        QuizState.StopQuiz();
        NavigationManager.NavigateTo("student/my-quizes", replace: true);
    }
}