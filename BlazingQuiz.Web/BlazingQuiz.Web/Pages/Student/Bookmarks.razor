@page "/student/bookmarks"
@using BlazingQuiz.Shared
@using BlazingQuiz.Shared.DTOs
@inject IBookmarkApi BookmarkApi
@inject IStudentQuizApi StudentQuizApi
@inject NavigationManager NavigationManager
@inject QuizState QuizState
@inject QuizImageService QuizImageService
@inject QuizAuthStateProvider QuizAuthStateProvider
@inject IAppState AppState

<BackButton />

<div class="container py-4">
    <h3 class="mb-4 welcome-title">Bookmarked Quizzes</h3>
    @if (_isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (_bookmarks.Count == 0)
    {
        <div class="col-12">
            <div class="empty-state">
                <div class="mb-3">
                    <i class="bi bi-bookmark-star fs-1 text-muted"></i>
                </div>
                <h5>You haven't bookmarked any quizzes yet.</h5>
                <p class="text-muted">Go to the <a href="/student/home">Quiz Home</a> page to find quizzes to bookmark.</p>
            </div>
        </div>
    }
    else if (_quizListData.Count == 0)
    {
        <div class="text-center">
            <p class="text-muted">Loading quiz details...</p>
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var quiz in _quizListData)
            {
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="quiz-card-3d position-relative h-100">
                        <!-- Quiz level badge -->
                        <div class="level-badge position-absolute top-0 start-0 m-3">
                            <span class="badge badge-@(quiz.Level?.ToLower() == "easy" ? "success" : quiz.Level?.ToLower() == "medium" ? "warning" : "danger")">
                                @quiz.Level
                            </span>
                        </div>

                        <!-- Bookmark button -->
                        <button type="button"
                                class="btn btn-bookmark"
                                @onclick="() => RemoveBookmarkAsync(quiz.Id)"
                                title="Remove bookmark">

                            <span class="material-symbols-outlined text-warning">
                                bookmark
                            </span>
                        </button>

                        <!-- Quiz image -->
                        @if (!string.IsNullOrEmpty(quiz.ImagePath))
                        {
                            <div class="quiz-image-container">
                                <img src="@QuizImageService.GetImageUrl(quiz.ImagePath)" alt="@quiz.Name" class="quiz-image" />
                            </div>
                        }
                        else
                        {
                            <div class="quiz-image quiz-image-placeholder d-flex align-items-center justify-content-center">
                                <i class="bi bi-journal-text fs-1 text-white"></i>
                            </div>
                        }

                        <!-- Quiz content -->
                        <div class="quiz-content p-3">
                            <h5 class="fw-bold mb-3 text-truncate" title="@quiz.Name">@quiz.Name</h5>

                            <!-- Quiz statistics -->
                            <div class="quiz-stats d-flex justify-content-between mt-auto">
                                <div class="stat-item d-flex flex-column align-items-center">
                                    <div class="d-flex align-items-center">
                                        <span class="material-symbols-outlined me-1" style="font-size: 16px;">
                                            @if (quiz.AverageRating.HasValue && quiz.AverageRating.Value > 0)
                                            {
                                                @:star
                                            }
                                            else
                                            {
                                                @:star_outline
                                            }
                                        </span>
                                        @if (quiz.AverageRating.HasValue)
                                        {
                                            <span class="stat-value fw-bold">@quiz.AverageRating.Value.ToString("F1")</span>
                                        }
                                        else
                                        {
                                            <span class="stat-value fw-bold text-muted">0</span>
                                        }
                                    </div>
                                    <small class="stat-label text-muted">Rating</small>
                                </div>
                                <div class="stat-item d-flex flex-column align-items-center">
                                    <div class="d-flex align-items-center mb-1">
                                        @if (!string.IsNullOrEmpty(quiz.CreatedByAvatarPath))
                                        {
                                            <img src="@QuizImageService.GetImageUrl(quiz.CreatedByAvatarPath)"
                                                 alt="@quiz.CreatedByName's avatar"
                                                 class="rounded-circle me-2"
                                                 style="width: 24px; height: 24px; object-fit: cover;"
                                                 title="@quiz.CreatedByName" />
                                        }
                                        else
                                        {
                                            <div class="rounded-circle me-2 d-flex align-items-center justify-content-center bg-secondary text-white"
                                                 style="width: 24px; height: 24px; font-size: 10px;"
                                                 title="@quiz.CreatedByName">
                                                @quiz.CreatedByName?.FirstOrDefault().ToString().ToUpper()
                                            </div>
                                        }
                                        <span class="stat-value fw-bold small">@quiz.CreatedByName</span>
                                    </div>
                                    <small class="stat-label text-muted">Creator</small>
                                </div>
                            </div>
                        </div>

                        <!-- Action buttons -->
                        <div class="card-button-overlay">
                            <div class="quiz-actions-section d-flex gap-1">
                                <button type="button"
                                        class="btn btn-3d btn-3d-info btn-sm flex-fill"
                                        @onclick="() => StartQuizAsync(quiz.Id, quiz.Name)">
                                    Start Quiz
                                </button>
                                <a href="student/createroom?quizId=@quiz.Id" class="btn btn-3d btn-3d-primary btn-sm flex-fill">
                                    Create Room
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if(_startingQuiz != null)
{
    var title = $"Starting Quiz: {_startingQuiz.Name}?";
    <Modal Title="@title" OnCancelClick="() => _startingQuiz = null" OnActionButtonClick="ConfirmStartQuizAsync">
        <p class="m-0 p-3">
            Are you sure you want to start the quiz?<br/>
            You will not able to pause the quiz
        </p>
    </Modal>
}

@code {
    private List<QuizBookmarkDto> _bookmarks = new();
    private List<QuizListDto> _quizListData = new();
    private bool _isLoading = false;
    private QuizListDto? _startingQuiz;
    private Guid _quizIdToStart;

    protected override async Task OnInitializedAsync()
    {
        if (!QuizAuthStateProvider.IsLoggedIn)
        {
            NavigationManager.NavigateTo("auth/login");
            return;
        }

        await LoadBookmarksAsync();
    }

    private async Task LoadBookmarksAsync()
    {
        _isLoading = true;
        var result = await BookmarkApi.GetBookmarksAsync(QuizAuthStateProvider.User.Id);
        if (result.IsSuccess)
        {
            _bookmarks = result.Data;

            // For each bookmarked quiz, fetch the full details to display
            _quizListData.Clear();
            foreach (var bookmark in _bookmarks)
            {
                // Get the quiz from the list of all active quizzes
                var allQuizzes = await StudentQuizApi.GetActiveQuizesAsync(0); // 0 means all categories
                var quiz = allQuizzes.FirstOrDefault(q => q.Id == bookmark.QuizId);
                if (quiz != null)
                {
                    _quizListData.Add(quiz);
                }
            }
        }
        _isLoading = false;
    }

    private async Task RemoveBookmarkAsync(Guid quizId)
    {
        var result = await BookmarkApi.RemoveBookmarkAsync(QuizAuthStateProvider.User.Id, quizId);
        if (result.IsSuccess)
        {
            _bookmarks.RemoveAll(b => b.QuizId == quizId);
            _quizListData.RemoveAll(q => q.Id == quizId);
            StateHasChanged(); // Refresh UI after removal
        }
    }

    private async Task StartQuizAsync(Guid quizId, string quizName)
    {
        // We need to get the full QuizListDto by fetching from the server
        // For this, we'll temporarily store the quiz ID and show a confirmation modal
        _quizIdToStart = quizId;

        // We need to fetch the quiz details to store in QuizState
        AppState.ShowLoader("Loading quiz details...");
        try
        {
            // Get the quiz from the list of all active quizzes
            var allQuizzes = await StudentQuizApi.GetActiveQuizesAsync(0); // 0 means all categories
            var quiz = allQuizzes.FirstOrDefault(q => q.Id == quizId);
            if (quiz != null)
            {
                _startingQuiz = quiz;
            }
            else
            {
                // Quiz might not be active anymore
                _startingQuiz = new QuizListDto
                {
                    Id = quizId,
                    Name = quizName
                };
            }
        }
        catch
        {
            throw;
        }
        finally
        {
            AppState.HideLoader();
        }
    }

    private async Task ConfirmStartQuizAsync()
    {
        if (_startingQuiz == null)
        {
            return;
        }

        AppState.ShowLoader("Preparing the quiz...");
        try
        {
            QuizApiResponse<int> response = await StudentQuizApi.StartQuizAsync(_startingQuiz.Id);
            if (response.IsSuccess)
            {
                int studentQuizId = response.Data;
                QuizState.StartQuiz(_startingQuiz, studentQuizId);
                NavigationManager.NavigateTo("student/quiz");
            }
            else
            {
                // Handle error (show message to user)
                Console.WriteLine($"Error starting quiz: {response.ErrorMessage}");
            }
        }
        catch
        {
            throw;
        }
        finally
        {
            AppState.HideLoader();
        }
    }

    private async Task RefreshBookmarksAsync()
    {
        await LoadBookmarksAsync();
    }

    private void ShowQuizDetails(Guid quizId)
    {
        // Navigate to quiz details page
        NavigationManager.NavigateTo($"/student/quiz/{quizId}");
    }

    private bool IsBookmarked(Guid quizId)
    {
        return _bookmarks.Exists(b => b.QuizId == quizId);
    }
}