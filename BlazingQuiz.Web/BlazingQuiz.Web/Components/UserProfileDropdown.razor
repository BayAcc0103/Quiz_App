@using BlazingQuiz.Shared
@using BlazingQuiz.Shared.DTOs
@using BlazingQuiz.Web.Apis
@inject QuizAuthStateProvider QuizAuthStateProvider
@inject IAuthApi AuthApi
@inject UserAvatarService UserAvatarService
@inject NavigationManager NavigationManager
@inject ProfileUpdateService ProfileUpdateService

<div class="dropdown user-profile-dropdown">
    <button class="btn btn-outline-light d-flex align-items-center py-0 gap-2" type="button" id="profileDropdown" aria-expanded="false">
        @if (!string.IsNullOrEmpty(_userDto?.AvatarPath))
        {
            <img src="@UserAvatarService.GetImageUrl(_userDto.AvatarPath)" 
                 alt="Avatar" 
                 class="rounded-circle" />
        }
        else
        {
            <img src="@UserAvatarService.GetImageUrl("images/user-avatars/default-avatar.svg")" 
                 alt="Default Avatar" 
                 class="rounded-circle" />
        }
        <span class="text-black">@QuizAuthStateProvider.User?.Name</span>
    </button>
</div>

@implements IDisposable
@code {
    private UserDto? _userDto;

    protected override async Task OnInitializedAsync()
    {
        ProfileUpdateService.OnAvatarUpdated += OnAvatarUpdated;
        await LoadUserProfile();
    }

    private void OnAvatarUpdated()
    {
        // Use InvokeAsync to properly handle async operations from event handler
        InvokeAsync(async () =>
        {
            await LoadUserProfile();
            StateHasChanged();
        });
    }

    private async Task LoadUserProfile()
    {
        if (QuizAuthStateProvider.IsLoggedIn)
        {
            try
            {
                _userDto = await AuthApi.GetProfileAsync();
            }
            catch (Exception ex)
            {
                // Handle error silently or log if needed
                Console.WriteLine($"Error loading user profile: {ex.Message}");
            }
        }
    }

    private string GetProfileUrl()
    {
        var role = QuizAuthStateProvider.User?.Role?.ToLower();
        return role switch
        {
            "student" => "/student/profile",
            "teacher" => "/teacher/profile",
            "admin" => "/admin/profile", // Assuming admin profile exists
            _ => "/auth/login"
        };
    }

    public void Dispose()
    {
        ProfileUpdateService.OnAvatarUpdated -= OnAvatarUpdated;
    }
}