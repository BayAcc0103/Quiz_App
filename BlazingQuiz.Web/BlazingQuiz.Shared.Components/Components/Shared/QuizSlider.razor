@using BlazingQuiz.Shared.DTOs
@using Microsoft.JSInterop
@inject QuizImageService QuizImageService
@inject NavigationManager NavigationManager
@inject IStudentQuizApi StudentQuizApi
@inject QuizState QuizState
@inject IBookmarkApi BookmarkApi
@inject QuizAuthStateProvider QuizAuthStateProvider
@inject IAppState AppState
@inject IJSRuntime JSRuntime

<div class="quiz-slider-container position-relative" style="margin: 2rem 0;" @ref="_sliderContainer">
    <!-- Navigation arrows -->
    <button type="button" class="slider-nav-btn slider-nav-btn-prev" @onclick="PrevSlide" aria-label="Previous slide">
        <span class="material-symbols-outlined"> arrow_circle_left </span>
    </button>

    <div class="quiz-slider overflow-hidden">
        <div class="slides-container" style="transform: translateX(@(-_currentSlide * 100)%)">
            @for (int i = 0; i < _slides.Count; i++)
            {
                <div class="slide">
                    <div class="d-flex flex-nowrap gap-3 justify-content-center slide-quiz-container">
                        @for (int j = 0; j < 3 && (i * 3 + j) < QuizList.Length; j++)
                        {
                            var quiz = QuizList[i * 3 + j];
                            <div class="quiz-card-container flex-shrink-0" style="flex: 1; min-width: 340px; max-width: 420px;">
                                <div class="quiz-card-3d position-relative h-100">
                                    <!-- Quiz level badge -->
                                    <div class="level-badge position-absolute top-0 start-0 m-3">
                                        <span class="badge badge-@(quiz.Level?.ToLower() == "easy" ? "success" : quiz.Level?.ToLower() == "medium" ? "warning" : "danger")">
                                            @quiz.Level
                                        </span>
                                    </div>

                                    <!-- Bookmark button -->
                                    <button type="button"
                                            class="btn btn-bookmark @(IsBookmarked(quiz.Id) ? "bookmarked" : "")"
                                            @onclick="() => ToggleBookmarkAsync(quiz)"
                                            title="@(IsBookmarked(quiz.Id) ? "Remove bookmark" : "Add to bookmarks")">

                                        <span class="material-symbols-outlined @(IsBookmarked(quiz.Id) ? "text-warning" : "text-muted")">
                                            @(IsBookmarked(quiz.Id) ? "bookmark" : "bookmark_add")
                                        </span>
                                    </button>

                                    <!-- Quiz image -->
                                    @if (!string.IsNullOrEmpty(quiz.ImagePath))
                                    {
                                        <div class="quiz-image-container">
                                            <img src="@QuizImageService.GetImageUrl(quiz.ImagePath)" alt="@quiz.Name" class="quiz-image" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="quiz-image quiz-image-placeholder d-flex align-items-center justify-content-center">
                                            <i class="bi bi-journal-text fs-1 text-white"></i>
                                        </div>
                                    }

                                    <!-- Quiz content -->
                                    <div class="quiz-content p-3">
                                        <h5 class="fw-bold mb-3 text-truncate" title="@quiz.Name">@quiz.Name</h5>

                                        <!-- Quiz statistics -->
                                        <div class="quiz-stats d-flex justify-content-between mt-auto">
                                            <div class="stat-item d-flex flex-column align-items-center">
                                                <span class="stat-value fw-bold">@quiz.TotalQuestions</span>
                                                <small class="stat-label text-muted">Questions</small>
                                            </div>
                                            <div class="stat-item d-flex flex-column align-items-center">
                                                <span class="stat-value fw-bold">@quiz.TimeInMinutes min</span>
                                                <small class="stat-label text-muted">Time</small>
                                            </div>
                                            <div class="stat-item d-flex flex-column align-items-center">
                                                <div class="d-flex align-items-center mb-1">
                                                    @if (!string.IsNullOrEmpty(quiz.CreatedByAvatarPath))
                                                    {
                                                        <img src="@QuizImageService.GetImageUrl(quiz.CreatedByAvatarPath)"
                                                             alt="@quiz.CreatedByName's avatar"
                                                             class="rounded-circle me-2"
                                                             style="width: 24px; height: 24px; object-fit: cover;"
                                                             title="@quiz.CreatedByName" />
                                                    }
                                                    else
                                                    {
                                                        <div class="rounded-circle me-2 d-flex align-items-center justify-content-center bg-secondary text-white"
                                                             style="width: 24px; height: 24px; font-size: 10px;"
                                                             title="@quiz.CreatedByName">
                                                            @quiz.CreatedByName?.FirstOrDefault().ToString().ToUpper()
                                                        </div>
                                                    }
                                                    <span class="stat-value fw-bold small">@quiz.CreatedByName</span>
                                                </div>
                                                <small class="stat-label text-muted">Creator</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action buttons -->
                                    <div class="card-button-overlay">
                                        <div class="quiz-actions-section d-flex gap-1">
                                            <button type="button"
                                                    class="btn btn-3d btn-3d-info btn-sm flex-fill"
                                                    @onclick="() => ShowQuizTypeSelection(quiz)">
                                                Start Quiz
                                            </button>
                                            <a href="student/createroom?quizId=@quiz.Id" class="btn btn-3d btn-3d-primary btn-sm flex-fill">
                                                Create Room
                                            </a>
                                            <button type="button"
                                                    class="btn btn-3d btn-3d-success btn-sm flex-fill"
                                                    @onclick="() => ShowQuizDetails(quiz.Id)">
                                                View Details
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Next navigation button -->
    <button type="button" class="slider-nav-btn slider-nav-btn-next" @onclick="NextSlide" aria-label="Next slide">
        <span class="material-symbols-outlined">
            arrow_circle_right
        </span>
    </button>

    <!-- Slide indicators -->
    <div class="slider-indicators d-flex justify-content-center mt-4">
        @for (int i = 0; i < _slides.Count; i++)
        {
            <button type="button"
                    class="indicator-btn mx-1 @(_currentSlide == i ? "active" : "")"
                    @onclick="() => GoToSlide(i)"
                    aria-label="Go to slide @(i + 1)">
            </button>
        }
    </div>
</div>

@code {
    [Parameter] public QuizListDto[] QuizList { get; set; } = [];
    [Parameter] public EventCallback<QuizListDto> OnQuizTypeSelection { get; set; }
    [Parameter] public EventCallback<Guid> OnQuizDetails { get; set; }
    [Parameter] public EventCallback<QuizListDto> OnBookmarkToggle { get; set; }

    private List<QuizListDto[]> _slides = new();
    private int _currentSlide = 0;
    private Dictionary<Guid, bool> _bookmarkedQuizes = new();
    private ElementReference _sliderContainer;
    private bool _isMobileView = false;

    protected override async Task OnParametersSetAsync()
    {
        // Calculate slides - 3 quizzes per slide on desktop, 1 for mobile
        // For now, we will determine the screen size and set accordingly
        _slides.Clear();

        // For now, default to 3 per slide - we'll adjust this later with JavaScript
        for (int i = 0; i < QuizList.Length; i += 3)
        {
            var slide = QuizList.Skip(i).Take(3).ToArray();
            _slides.Add(slide);
        }

        _currentSlide = 0; // Reset to first slide when quizzes change
        StateHasChanged();
    }


    private async Task DetectScreenSize()
    {
        try
        {
            // Check if the screen width is less than or equal to 576px (mobile)
            var windowWidth = await JSRuntime.InvokeAsync<int>("eval", "window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth");
            _isMobileView = windowWidth <= 576;

            // Rebuild slides based on screen size
            await RebuildSlidesBasedOnScreenSize(windowWidth);
        }
        catch
        {
            // Default to desktop view if JS call fails
            _isMobileView = false;
        }
    }

    private async Task RebuildSlidesBasedOnScreenSize(int windowWidth)
    {
        _slides.Clear();

        int quizzesPerSlide = windowWidth <= 576 ? 1 : 3;

        for (int i = 0; i < QuizList.Length; i += quizzesPerSlide)
        {
            var slide = QuizList.Skip(i).Take(quizzesPerSlide).ToArray();
            _slides.Add(slide);
        }

        // Adjust current slide if needed
        if (_currentSlide >= _slides.Count && _slides.Count > 0)
        {
            _currentSlide = _slides.Count - 1;
        }

        StateHasChanged();
    }

    private DotNetObjectReference<QuizSlider>? _objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Create a reference to this component for JavaScript interop
            _objRef = DotNetObjectReference.Create(this);

            // Detect screen size after render
            await DetectScreenSize();
            await LoadBookmarkStatusAsync();

            // Register resize event listener
            await JSRuntime.InvokeVoidAsync("eval", @"
                if (!window.quizSliderResizeHandler) {
                    let dotNetHelperRef = null;

                    window.quizSliderResizeHandler = (dotNetHelper) => {
                        dotNetHelperRef = dotNetHelper; // Store reference for resize handler
                        setTimeout(() => {
                            const windowWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
                            dotNetHelper.invokeMethodAsync('RebuildSlidesBasedOnScreenSizeFromJS', windowWidth);
                        }, 100);
                    };

                    window.addEventListener('resize', (e) => {
                        if (dotNetHelperRef) {
                            window.quizSliderResizeHandler(dotNetHelperRef);
                        }
                    });
                }
            ", _objRef);

            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task RebuildSlidesBasedOnScreenSizeFromJS(int windowWidth)
    {
        await RebuildSlidesBasedOnScreenSize(windowWidth);
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            // Remove event listener when component is disposed
            await JSRuntime.InvokeVoidAsync("eval", @"
                if (window.quizSliderResizeHandler) {
                    window.removeEventListener('resize', window.quizSliderResizeHandler);
                    delete window.quizSliderResizeHandler;
                }
            ");

            _objRef?.Dispose();
        }
        catch { /* Ignore errors during disposal */ }
    }

    private async Task LoadBookmarkStatusAsync()
    {
        if (!QuizAuthStateProvider.IsLoggedIn)
        {
            return;
        }

        _bookmarkedQuizes.Clear();
        foreach (var quiz in QuizList)
        {
            var result = await BookmarkApi.IsBookmarkedAsync(QuizAuthStateProvider.User.Id, quiz.Id);
            if (result.IsSuccess)
            {
                _bookmarkedQuizes[quiz.Id] = result.Data;
            }
        }
    }

    private async Task ToggleBookmarkAsync(QuizListDto quiz)
    {
        if (!QuizAuthStateProvider.IsLoggedIn)
        {
            NavigationManager.NavigateTo("auth/login");
            return;
        }

        var isBookmarked = _bookmarkedQuizes.ContainsKey(quiz.Id) && _bookmarkedQuizes[quiz.Id];

        if (isBookmarked)
        {
            // Remove bookmark
            var result = await BookmarkApi.RemoveBookmarkAsync(QuizAuthStateProvider.User.Id, quiz.Id);
            if (result.IsSuccess)
            {
                _bookmarkedQuizes[quiz.Id] = false;
            }
        }
        else
        {
            // Add bookmark
            var bookmarkDto = new QuizBookmarkDto
                {
                    UserId = QuizAuthStateProvider.User.Id,
                    QuizId = quiz.Id,
                    QuizName = quiz.Name,
                    CategoryName = quiz.CategoryName
                };

            var result = await BookmarkApi.AddBookmarkAsync(bookmarkDto);
            if (result.IsSuccess)
            {
                _bookmarkedQuizes[quiz.Id] = true;
            }
        }

        await OnBookmarkToggle.InvokeAsync(quiz);
        StateHasChanged();
    }

    private bool IsBookmarked(Guid quizId)
    {
        return _bookmarkedQuizes.ContainsKey(quizId) && _bookmarkedQuizes[quizId];
    }

    private async Task ShowQuizTypeSelection(QuizListDto quiz)
    {
        await OnQuizTypeSelection.InvokeAsync(quiz);
    }

    private async Task ShowQuizDetails(Guid quizId)
    {
        await OnQuizDetails.InvokeAsync(quizId);
    }

    private void NextSlide()
    {
        if (_currentSlide < _slides.Count - 1)
        {
            _currentSlide++;
            StateHasChanged();
        }
    }

    private void PrevSlide()
    {
        if (_currentSlide > 0)
        {
            _currentSlide--;
            StateHasChanged();
        }
    }

    private void GoToSlide(int slideIndex)
    {
        if (slideIndex >= 0 && slideIndex < _slides.Count)
        {
            _currentSlide = slideIndex;
            StateHasChanged();
        }
    }
}