@implements IDisposable
@inject IAppState AppState

<div class="html-timer-container">
    <div class="timer-progress-container">
        <div class="timer-progress-bar" style="width: @_progressPercentage%;">
            <div class="timer-text">@_currentDisplayTime/@_totalDisplayTime</div>
        </div>
    </div>
</div>

@code{
    [Parameter, EditorRequired]
    public int TotalMinutes { get; set; }

    [Parameter]
    public EventCallback OnTimerStop { get; set; }
    
    private DateTime _totalTime;
    private string _totalDisplayTime = "";
    private string _currentDisplayTime = "00:00";
    private double _progressPercentage = 100;
    private bool _isLowTime = false;
    private PeriodicTimer? _periodicTimer;

    protected override void OnInitialized()
    {
        _totalDisplayTime = $"{TotalMinutes.ToString().PadLeft(2, '0')}:00";
        _totalTime = DateTime.Now.AddMinutes(TotalMinutes);
        _periodicTimer = new PeriodicTimer(TimeSpan.FromSeconds(1));
        HandleTimerAsync();
    }

    private async Task HandleTimerAsync()
    {
        while (await _periodicTimer!.WaitForNextTickAsync())
        {
            try
            {
                var diff = _totalTime - DateTime.Now;
                if (diff <= TimeSpan.Zero)
                {
                    //Timer should stop
                    _periodicTimer.Dispose();
                    _periodicTimer = null;
                    await OnTimerStop.InvokeAsync();
                    return;
                }
                
                // Check if time is running low (less than 1 minute)
                _isLowTime = diff.TotalSeconds <= 60;
                
                _currentDisplayTime = diff.ToString("mm\\:ss");
                
                // Calculate progress percentage
                var elapsed = TimeSpan.FromMinutes(TotalMinutes) - diff;
                var progress = elapsed.TotalMinutes / TotalMinutes;
                _progressPercentage = 100 * (1 - progress); // Invert so it goes from 100 to 0
                
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                AppState.ShowError(ex.Message);
            }
        }
    }

    public void Dispose()
    {
        if (_periodicTimer != null)
        {
            _periodicTimer.Dispose();
        }
    }
}