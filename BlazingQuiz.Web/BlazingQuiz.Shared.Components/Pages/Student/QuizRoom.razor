@page "/student/quiz/{QuizId:guid}/room/{RoomId:guid}"
@using BlazingQuiz.Shared.Components.Services.SignalR
@using BlazingQuiz.Shared.DTOs
@inject NavigationManager NavigationManager
@inject QuizState QuizState
@inject IStudentQuizApi StudentQuizApi
@inject IRoomApi RoomApi
@inject IRoomQuizApi RoomQuizApi
@inject QuizHubService QuizHubService
@inject IAppState AppState
@inject QuestionImageService QuestionImageService
@inject QuizAudioService QuizAudioService
@inject QuestionAudioService QuestionAudioService
@inject QuizAuthStateProvider QuizAuthStateProvider
@inject IJSRuntime JSRuntime

@layout QuizPageLayout

@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Joining room and preparing quiz...</p>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger card-3d-raised">@errorMessage</div>
}
else
{
    @if (isQuizStarted)
    {
        @if (showWaitingMessage)
        {
            <!-- Show waiting message after user has submitted but others haven't -->
            <div class="container mt-5">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="card card-3d-raised text-center">
                            <div class="card-body p-5">
                                <div class="mb-4">
                                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                                </div>
                                <h4 class="card-title text-success">Nộp quiz thành công!</h4>
                                <p class="card-text">Vui lòng chờ người chơi khác hoàn thành bài quiz.</p>
                                <div class="d-flex justify-content-center my-4">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Đang chờ...</span>
                                    </div>
                                </div>
                                <p class="text-muted">
                                    <small>Đang chờ @GetUnsubmittedCount() người chơi khác hoàn thành bài quiz...</small>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <div class="d-flex justify-content-center mb-4">
                            <!-- Hanging element showing the quiz name -->
                            <div class="hanging-quiz-info hanging-quiz-title">
                                <div class="hanging-content">
                                    <h3 class="mb-0">@quizName</h3>
                                </div>
                                <div class="rope left-rope"></div>
                                <div class="rope right-rope"></div>
                            </div>
                        </div>

                        <!-- HTML Timer above the main quiz card -->
                        <div class="html-timer-above-card mb-3">
                            <HtmlQuizTimer TotalMinutes="quizTimeInMinutes" OnTimerStop="AutoSubmitQuizAsync" />
                        </div>

                        <!-- Main content area with question count to the left and quiz card to the right -->
                        <div class="row">
                            <div class="col-3">
                                <!-- Left hanging - question count -->
                                <div class="hanging-quiz-info hanging-question-current me-2">
                                    <div class="hanging-content hanging-content-smaller">
                                        <h4 class="mb-0">@(_currentQuestionIndex + 1)</h4>
                                    </div>
                                    <div class="rope left-rope"></div>
                                    <div class="rope right-rope"></div>
                                </div>

                                <!-- Middle hanging - separator -->
                                <div class="hanging-quiz-info hanging-separator mx-2">
                                    <div class="hanging-content hanging-content-smaller">
                                        <h4 class="mb-0">/</h4>
                                    </div>
                                    <div class="rope left-rope"></div>
                                    <div class="rope right-rope"></div>
                                </div>

                                <!-- Right hanging - total questions -->
                                <div class="hanging-quiz-info hanging-question-total ms-2">
                                    <div class="hanging-content hanging-content-smaller">
                                        <h4 class="mb-0">@_totalQuestions</h4>
                                    </div>
                                    <div class="rope left-rope"></div>
                                    <div class="rope right-rope"></div>
                                </div>
                            </div>

                            <div class="col-9">
                                <!-- Combined card: Question and Options -->
                                <div class="card card-3d-raised card-light">
                                    <div class="card-body">
                                        <!-- Question Section -->
                                        <div class="question-container">
                                            <!-- Question Image -->
                                            @if (!string.IsNullOrEmpty(currentQuestion?.ImagePath))
                                            {
                                                <div class="question-image-container">
                                                    <img src="@QuestionImageService.GetImageUrl(currentQuestion.ImagePath)" alt="Question Image" class="img-fluid" />
                                                </div>
                                            }

                                            <!-- Question Audio -->
                                            @if (!string.IsNullOrEmpty(currentQuestion?.AudioPath))
                                            {
                                                <div class="question-audio-container">
                                                    @if (currentQuestion.AudioPath.EndsWith(".mp3", StringComparison.OrdinalIgnoreCase))
                                                    {
                                                        <audio controls class="w-100">
                                                            <source src="@QuestionAudioService.GetAudioUrl(currentQuestion.AudioPath)" type="audio/mpeg" />
                                                            Your browser does not support the audio element.
                                                        </audio>
                                                    }
                                                    else
                                                    {
                                                        <div class="alert alert-info card-3d-raised">Audio file available: @currentQuestion.AudioPath</div>
                                                    }
                                                </div>
                                            }

                                            <!-- Question Text -->
                                            <div class="question-text">@currentQuestion?.Text</div>
                                        </div>

                                        <!-- Options Section - Now inside the same card -->
                                        <div class="options-container">
                                            @if (currentQuestion != null && !currentQuestion.IsTextAnswer)
                                            {
                                                <!-- Multiple Choice Options as Square Cards -->
                                                <div class="options-grid">
                                                    @foreach (var o in currentQuestion.Options)
                                                    {
                                                        <div class="option-square-card @(selectedOptionId == o.Id ? "selected" : "")" @onclick="() => SelectOption(o.Id)">
                                                            <div class="option-content">
                                                                <div class="option-text">@o.Text</div>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            else if (currentQuestion != null && currentQuestion.IsTextAnswer)
                                            {
                                                <!-- Text Input Field -->
                                                <div class="text-answer-input">
                                                    <input type="text" class="form-control form-control-lg" placeholder="Enter your answer" @bind="textAnswer" />
                                                </div>
                                            }
                                        </div>

                                        <!-- Error Message -->
                                        @if (!string.IsNullOrEmpty(errorMessage))
                                        {
                                            <div class="alert alert-danger card-3d-raised mt-3">
                                                <span>@errorMessage</span>
                                                <button type="button" class="btn-close float-end" @onclick="() => errorMessage = null" aria-label="Close"></button>
                                            </div>
                                        }
                                    </div>

                                    <!-- Quiz Footer with Navigation -->
                                    <div class="card-footer">
                                        <div class="quiz-navigation d-flex justify-content-between align-items-center">
                                            <button type="button" class="btn btn-3d btn-3d-danger" @onclick="ExitQuiz">Exit Quiz</button>
                                            @if (!isLastQuestion)
                                            {
                                                <button type="button" class="btn btn-3d btn-3d-primary" @onclick="SubmitCurrentAnswer">Submit Answer</button>
                                            }
                                            else
                                            {
                                                <button type="button" class="btn btn-3d btn-3d-success" @onclick="SubmitQuiz">Submit Quiz</button>
                                            }
                                        </div>
                                    </div>
                                </div> <!-- End of card -->
                            </div> <!-- End of col -->
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <!-- Waiting room before quiz starts -->
        <div class="container mt-5">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card card-3d-raised">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">Quiz Room</h4>
                        </div>
                        <div class="card-body text-center">
                            <h5>Waiting for the host to start the quiz...</h5>
                            <div class="spinner-border mt-4" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>

                            <div class="mt-4">
                                <h6>Quiz: @quizName</h6>
                                <p class="text-muted">Room: @roomCode</p>
                            </div>

                            @if (isHost)
                            {
                                <div class="mt-4">
                                    <button class="btn btn-3d btn-3d-success btn-lg" @onclick="StartQuizForRoom">Start Quiz for All</button>
                                    <p class="mt-2">Click when all participants are ready to begin the quiz</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
}

<style>
    .option-box {
        transition: all ease 0.2s;
    }
    .option-box:hover {
        border-radius: 10px;
        box-shadow: 0 0 18px 1px #bebebe;
    }
    
    .emotion-icon {
        transition: all ease 0.3s;
        border-radius: 50%;
        padding: 10px;
        position: relative;
    }
    
    .emotion-icon.selected {
        color: #0d6efd !important;
        -webkit-animation: pulse 2s infinite;
        animation: pulse 2s infinite;
        background-color: rgba(13, 110, 253, 0.1);
        box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
    }
    
    @@keyframes pulse {
        0% { 
            box-shadow: 0 0 5px rgba(13, 110, 253, 0.5);
        }
        50% { 
            box-shadow: 0 0 20px rgba(13, 110, 253, 0.8);
        }
        100% { 
            box-shadow: 0 0 5px rgba(13, 110, 253, 0.5);
        }
    }
    
    .emotion-icon:hover {
        transform: scale(1.2);
        background-color: #f0f8ff;
    }
</style>

@code {
    [Parameter]
    public Guid QuizId { get; set; }
    
    [Parameter]
    public Guid RoomId { get; set; }
    
    private bool isLoading = true;
    private bool isQuizStarted = false;
    private bool isHost = false;
    private bool hasSubmitted = false;
    private bool showWaitingMessage = false;
    private string? errorMessage;
    private string? roomCode;
    private string? quizName;
    private int quizTimeInMinutes;
    private int? currentQuestionId;
    private QuestionDto? currentQuestion;
    private int _currentQuestionIndex = 0;
    private int _totalQuestions = 0;
    private int selectedOptionId = 0;
    private string? textAnswer;
    private bool isLastQuestion = false;
    private int studentQuizForRoomId = 0;
    private List<RoomParticipantDto> roomParticipants = new();
    private int unsubmittedCount = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Check if user is logged in
            if (!QuizAuthStateProvider.IsLoggedIn)
            {
                NavigationManager.NavigateTo("/auth/login", replace: true);
                return;
            }

            // Verify user is a participant in this room
            var participants = await RoomApi.GetRoomParticipantsAsync(RoomId);
            var currentUser = participants.FirstOrDefault(p => p.UserId == QuizAuthStateProvider.User.Id);
            
            if (currentUser == null)
            {
                errorMessage = "You are not a participant in this room.";
                isLoading = false;
                return;
            }

            // Check if user is the host
            var roomDto = await RoomApi.GetRoomByIdAsync(RoomId);
            if (roomDto?.CreatedBy == QuizAuthStateProvider.User.Id)
            {
                isHost = true;
            }
            
            roomCode = roomDto?.Code;
            quizName = roomDto?.QuizName ?? "Quiz";

            // Check if the room has already started - if so, start the quiz immediately
            if (roomDto?.StartedAt.HasValue == true)
            {
                isQuizStarted = true;
            }

            // Set up SignalR connection - make sure connection is started
            if (!QuizHubService.IsConnected)
            {
                try
                {
                    await QuizHubService.StartConnectionAsync();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to establish SignalR connection: {ex.Message}");
                    // Optionally show a user-friendly message or continue with limited functionality
                    errorMessage = "Real-time updates may not be available due to connection issues. Some features might not work properly.";
                }
            }

            // Set up SignalR connection
            QuizHubService.OnQuizStarted += HandleQuizStarted;
            QuizHubService.OnQuizEnded += HandleQuizEnded; // Add event handler for when quiz ends for all
            QuizHubService.OnUserRemovedFromRoom += HandleUserRemovedFromRoom; // Add event handler for when user is removed from room

            // Join the room in SignalR
            if (!string.IsNullOrEmpty(roomCode) && QuizHubService.IsConnected)
            {
                try
                {
                    await QuizHubService.JoinRoomAsync(roomCode);
                    Console.WriteLine($"Successfully joined room {roomCode} via SignalR in QuizRoom");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to join room via SignalR: {ex.Message}");
                    errorMessage = "Unable to join the room for real-time updates. Some features might not work properly.";
                }
            }
            else if (string.IsNullOrEmpty(roomCode))
            {
                Console.WriteLine("Room code is null or empty, skipping JoinRoom call");
            }
            else if (!QuizHubService.IsConnected)
            {
                Console.WriteLine("SignalR is not connected, skipping JoinRoom call");
            }
            
            // If the quiz has already started, initialize it now
            if (isQuizStarted)
            {
                await InitializeQuizAsync();
            }
            
            // Start polling to check if user is still in room
            _ = CheckIfUserStillInRoom(); // Fire and forget
            
            isLoading = false;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error initializing room: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task StartQuizForRoom()
    {
        try
        {
            AppState.ShowLoader("Starting quiz for all participants...");
            
            // Call API to start quiz for room - this API call sends the SignalR event to all participants
            var response = await RoomApi.StartQuizAsync(RoomId);
            
            if (response.IsSuccessStatusCode)
            {
                // The host should start the quiz immediately as well, not wait for the SignalR event
                // This prevents any race condition issues
                isQuizStarted = true;
                await InitializeQuizAsync();
                StateHasChanged();
            }
            else
            {
                errorMessage = "Failed to start quiz: " + response.Error?.Message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error starting quiz: " + ex.Message;
        }
        finally
        {
            AppState.HideLoader();
        }
    }

    private void HandleQuizStarted(string roomCode)
    {
        InvokeAsync(async () =>
        {
            // Only handle the event if it's for this room
            if (roomCode == this.roomCode)
            {
                isQuizStarted = true;
                
                // Initialize quiz for the participant
                await InitializeQuizAsync();
                StateHasChanged();
            }
        });
    }

    private void HandleQuizEnded(string roomCode)
    {
        InvokeAsync(async () =>
        {
            // Only handle the event if it's for this room
            if (roomCode == this.roomCode)
            {
                // Show leaderboard to all participants
                NavigationManager.NavigateTo($"/student/quiz/{QuizId}/room/{RoomId}/leaderboard", replace: true);
            }
        });
    }

    private async Task InitializeQuizAsync()
    {
        try
        {
            AppState.ShowLoader("Preparing quiz...");
            
            // Initialize quiz state for room - this returns the studentQuizForRoomId
            var quizResponse = await RoomQuizApi.StartQuizForRoomAsync(RoomId);
            if (!quizResponse.IsSuccess || quizResponse.Data == 0) // studentQuizForRoomId should not be 0
            {
                errorMessage = "Failed to start quiz: " + quizResponse.ErrorMessage;
                return;
            }

            studentQuizForRoomId = quizResponse.Data;

            // Get quiz details to get time and total questions
            var quizDetailsResponse = await StudentQuizApi.GetQuizDetailsAsync(QuizId);
            if (!quizDetailsResponse.IsSuccess || quizDetailsResponse.Data == null)
            {
                errorMessage = "Failed to load quiz details: " + quizDetailsResponse.ErrorMessage;
                return;
            }

            quizTimeInMinutes = quizDetailsResponse.Data.TimeInMinutes;
            _totalQuestions = quizDetailsResponse.Data.TotalQuestions;

            // Get the first question
            await LoadNextQuestionAsync();
        }
        catch (Exception ex)
        {
            errorMessage = "Error initializing quiz: " + ex.Message;
        }
        finally
        {
            AppState.HideLoader();
        }
    }

    private async Task LoadNextQuestionAsync()
    {
        try
        {
            AppState.ShowLoader("Loading question...");
            
            var result = await RoomQuizApi.GetNextQuestionForRoomQuizAsync(studentQuizForRoomId);
            if (!result.IsSuccess || result.Data == null)
            {
                errorMessage = result.ErrorMessage ?? "Failed to load question";
                return;
            }
            
            currentQuestion = result.Data;
            currentQuestionId = currentQuestion.Id;
            isLastQuestion = (_currentQuestionIndex + 1) == _totalQuestions;
            
            // Reset selected answer
            selectedOptionId = 0;
            textAnswer = null;
        }
        catch (Exception ex)
        {
            errorMessage = "Error loading question: " + ex.Message;
        }
        finally
        {
            AppState.HideLoader();
        }
    }

    private void SelectOption(int optionId)
    {
        selectedOptionId = optionId;
    }

    private void OnTextAnswerChanged(ChangeEventArgs e)
    {
        textAnswer = e.Value?.ToString();
    }

    private async Task SubmitCurrentAnswer()
    {
        try
        {
            if (currentQuestion == null)
            {
                errorMessage = "No question to answer";
                return;
            }

            if (currentQuestion.IsTextAnswer && string.IsNullOrWhiteSpace(textAnswer))
            {
                errorMessage = "Please enter an answer";
                return;
            }

            if (!currentQuestion.IsTextAnswer && selectedOptionId == 0)
            {
                errorMessage = "Please select an option";
                return;
            }

            AppState.ShowLoader("Saving answer...");
            
            // Save the answer using the existing API
            StudentQuizQuestionResponseDto responseDto;
            if (currentQuestion.IsTextAnswer)
            {
                responseDto = new StudentQuizQuestionResponseDto(studentQuizForRoomId, currentQuestion.Id, 0, textAnswer);
            }
            else
            {
                responseDto = new StudentQuizQuestionResponseDto(studentQuizForRoomId, currentQuestion.Id, selectedOptionId);
            }

            var result = await RoomQuizApi.SaveQuestionResponseForRoomQuizAsync(studentQuizForRoomId, responseDto);
            if (!result.IsSuccess)
            {
                errorMessage = result.ErrorMessage ?? "Failed to save answer";
                return;
            }

            // Submit answer to room as well
            var roomAnswerDto = new RoomAnswerDto
            {
                RoomId = RoomId,
                UserId = QuizAuthStateProvider.User.Id,
                QuestionId = currentQuestion.Id,
                OptionId = currentQuestion.IsTextAnswer ? null : selectedOptionId,
                TextAnswer = currentQuestion.IsTextAnswer ? textAnswer : null,
                AnsweredAt = DateTime.UtcNow
            };

            var roomResult = await RoomApi.SubmitAnswerAsync(roomAnswerDto, RoomId);
            if (!roomResult.IsSuccessStatusCode)
            {
                errorMessage = "Failed to record answer in room: " + roomResult.Error?.Message;
                return;
            }

            // Move to next question if not last
            if (!isLastQuestion)
            {
                _currentQuestionIndex++;
                await LoadNextQuestionAsync();
            }
            else
            {
                // This will be the last question, so prepare for submit
                errorMessage = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error submitting answer: " + ex.Message;
        }
        finally
        {
            AppState.HideLoader();
        }
    }

    private async Task SubmitQuiz()
    {
        try
        {
            AppState.ShowLoader("Submitting quiz...");
            
            // Ensure the final answer is saved to StudentQuizQuestion table if there's a current question
            if (currentQuestion != null && (selectedOptionId != 0 || (!string.IsNullOrWhiteSpace(textAnswer) && currentQuestion.IsTextAnswer)))
            {
                // Save the answer to StudentQuizQuestion table using the existing API
                StudentQuizQuestionResponseDto responseDto;
                if (currentQuestion.IsTextAnswer)
                {
                    responseDto = new StudentQuizQuestionResponseDto(studentQuizForRoomId, currentQuestion.Id, 0, textAnswer);
                }
                else
                {
                    responseDto = new StudentQuizQuestionResponseDto(studentQuizForRoomId, currentQuestion.Id, selectedOptionId);
                }

                var saveResult = await RoomQuizApi.SaveQuestionResponseForRoomQuizAsync(studentQuizForRoomId, responseDto);
                if (!saveResult.IsSuccess)
                {
                    errorMessage = saveResult.ErrorMessage ?? "Failed to save final answer";
                    return;
                }
            }

            // Call the API to update the status to 'Completed' in the database
            var result = await RoomQuizApi.SubmitRoomQuizAsync(studentQuizForRoomId);
            if (!result.IsSuccess)
            {
                errorMessage = result.ErrorMessage ?? "Failed to submit quiz";
                return;
            }

            // Ensure the final answer is also saved to RoomAnswer table if there's a current question
            if (currentQuestion != null && (selectedOptionId != 0 || (!string.IsNullOrWhiteSpace(textAnswer) && currentQuestion.IsTextAnswer)))
            {
                // Check if this answer has already been saved (to prevent duplicates)
                var existingAnswers = await RoomApi.GetRoomAnswersForUserAsync(RoomId, QuizAuthStateProvider.User.Id);
                var hasSavedCurrentAnswer = existingAnswers.Any(ra => ra.QuestionId == currentQuestion.Id);

                if (!hasSavedCurrentAnswer)
                {
                    var roomAnswerDto = new RoomAnswerDto
                    {
                        RoomId = RoomId,
                        UserId = QuizAuthStateProvider.User.Id,
                        QuestionId = currentQuestion.Id,
                        OptionId = currentQuestion.IsTextAnswer ? null : selectedOptionId,
                        TextAnswer = currentQuestion.IsTextAnswer ? textAnswer : null,
                        AnsweredAt = DateTime.UtcNow
                    };

                    var roomResult = await RoomApi.SubmitAnswerAsync(roomAnswerDto, RoomId);
                    if (!roomResult.IsSuccessStatusCode)
                    {
                        errorMessage = "Failed to record final answer in room: " + roomResult.Error?.Message;
                        return;
                    }
                }
            }
            // if (!roomResult.IsSuccess)
            // {
            //     errorMessage = roomResult.ErrorMessage ?? "Failed to submit quiz";
            //     return;
            // }

            // Mark that this participant has submitted
            hasSubmitted = true;

            // Notify the room that this user has submitted
            var submitResult = await RoomApi.SubmitQuizToRoomAsync(new SubmitQuizToRoomRequest { StudentQuizId = studentQuizForRoomId }, RoomId);
            if (!submitResult.IsSuccessStatusCode)
            {
                errorMessage = "Failed to record submission in room: " + submitResult.Error?.Message;
                return;
            }

            // Check if all participants have submitted
            var allParticipants = await RoomApi.GetSubmissionStatusAsync(RoomId);
            var totalParticipants = allParticipants.Length;
            var submittedParticipants = allParticipants.Count(p => p.HasSubmitted);

            if (submittedParticipants == totalParticipants)
            {
                // All participants have submitted, so end the quiz for everyone
                if (isHost)
                {
                    await QuizHubService.EndQuizAsync(roomCode); // Trigger end quiz for all
                }
            }
            else
            {
                // Show waiting message to the current user who submitted early
                showWaitingMessage = true;
                errorMessage = null; // Clear any error messages
                
                // Start updating the unsubmitted count
                _ = StartUpdatingUnsubmittedCount(); // Fire and forget
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error submitting quiz: " + ex.Message;
        }
        finally
        {
            AppState.HideLoader();
            StateHasChanged(); // Update the UI to show waiting message
        }
    }

    private async Task AutoSubmitQuizAsync()
    {
        try
        {
            // Call SubmitQuiz instead of the original auto submit to use our new logic
            await SubmitQuiz();
        }
        catch (Exception ex)
        {
            errorMessage = "Error auto-submitting quiz: " + ex.Message;
        }
    }

    private void ExitQuiz()
    {
        QuizHubService.LeaveRoomAsync(roomCode);
        NavigationManager.NavigateTo("/student/home", replace: true);
    }

    private async Task<int> GetUnsubmittedCountAsync()
    {
        try
        {
            var allParticipants = await RoomApi.GetSubmissionStatusAsync(RoomId);
            var totalParticipants = allParticipants.Length;
            var submittedParticipants = allParticipants.Count(p => p.HasSubmitted);
            
            return totalParticipants - submittedParticipants;
        }
        catch
        {
            // Return 0 if we can't get the count
            return 0;
        }
    }

    private int GetUnsubmittedCount()
    {
        // Return the current unsubmitted count
        return unsubmittedCount;
    }

    private async Task StartUpdatingUnsubmittedCount()
    {
        // Update the count immediately
        unsubmittedCount = await GetUnsubmittedCountAsync();
        StateHasChanged();

        // Then update every 2 seconds while showing the waiting message
        while (showWaitingMessage)
        {
            await Task.Delay(2000); // Wait 2 seconds
            
            if (showWaitingMessage) // Check again if we should still be updating
            {
                unsubmittedCount = await GetUnsubmittedCountAsync();
                
                // Check if all participants have submitted
                if (unsubmittedCount == 0)
                {
                    // All participants have submitted - redirect to leaderboard
                    NavigationManager.NavigateTo($"/student/quiz/{QuizId}/room/{RoomId}/leaderboard", replace: true);
                    break;
                }
                
                StateHasChanged();
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        // Unsubscribe from SignalR events
        QuizHubService.OnQuizStarted -= HandleQuizStarted;
        QuizHubService.OnQuizEnded -= HandleQuizEnded; // Remove the event handler that was added
        QuizHubService.OnUserRemovedFromRoom -= HandleUserRemovedFromRoom; // Remove the event handler that was added

        // Leave the room in SignalR
        if (!string.IsNullOrEmpty(roomCode))
        {
            try
            {
                await QuizHubService.LeaveRoomAsync(roomCode);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error leaving room via SignalR: {ex.Message}");
            }
        }
    }

    private async void HandleUserRemovedFromRoom(string roomCode, string roomName, string hostName)
    {
        await InvokeAsync(async () =>
        {
            // Show notification that user was removed from the room
            await ShowAlertAsync($"You have been removed from room '{roomName}' by {hostName}.", "Removed from Room");

            // Leave the room in SignalR before navigating away
            if (!string.IsNullOrEmpty(this.roomCode))
            {
                await QuizHubService.LeaveRoomAsync(this.roomCode);
            }

            // Navigate to home page
            NavigationManager.NavigateTo("/student/home");
        });
    }

    private async Task ShowAlertAsync(string message, string title = "Error") =>
        await JSRuntime.InvokeVoidAsync("alert", $"{title}\n{message}");

    private async Task CheckIfUserStillInRoom()
    {
        // Check every 5 seconds if the user is still in the room
        while (true)
        {
            await Task.Delay(5000); // Wait 5 seconds before checking again

            try
            {
                var participants = await RoomApi.GetRoomParticipantsAsync(RoomId);
                var currentUser = participants.FirstOrDefault(p => p.UserId == QuizAuthStateProvider.User.Id);

                // If the current user is no longer in the room, redirect to home
                if (currentUser == null)
                {
                    await InvokeAsync(async () =>
                    {
                        // Leave the room in SignalR before navigating away
                        if (!string.IsNullOrEmpty(this.roomCode))
                        {
                            await QuizHubService.LeaveRoomAsync(this.roomCode);
                        }

                        // Navigate to home page
                        NavigationManager.NavigateTo("/student/home");
                    });
                    
                    break; // Stop polling
                }
            }
            catch
            {
                // If there's an error checking, continue polling
                continue;
            }
        }
    }
}