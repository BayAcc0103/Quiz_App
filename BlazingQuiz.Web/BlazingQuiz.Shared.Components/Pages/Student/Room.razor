@page "/student/room/{roomId:guid}"
@using BlazingQuiz.Shared.DTOs
@using BlazingQuiz.Shared.Components.Apis
@using BlazingQuiz.Shared
@using Microsoft.AspNetCore.Authorization
@using BlazingQuiz.Shared.Components.Services.SignalR
@attribute [Authorize(Roles = nameof(UserRole.Student))]
@inject IRoomApi RoomApi
@inject IStudentQuizApi StudentQuizApi
@inject QuizImageService QuizImageService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject QuizAuthStateProvider QuizAuthStateProvider
@inject QuizHubService QuizHubService

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">@room?.Name</h3>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-light text-dark me-3">
                            <i class="bi bi-people-fill me-1"></i> @participants.Length/@room?.MaxParticipants
                        </span>
                        <span class="badge bg-light text-dark me-3">
                            <i class="bi bi-code-slash me-1"></i> @room?.Code
                        </span>
                        <button type="button" class="btn btn-sm btn-light" @onclick="LeaveRoom">
                            <i class="bi bi-box-arrow-right me-1"></i> Leave Room
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">@errorMessage</div>
                    }
                    else if (isLoading)
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Loading room information...</p>
                        </div>
                    }
                    else
                    {
                        <div class="mb-4">
                            <h5>Room Description</h5>
                            <p>@(string.IsNullOrEmpty(room?.Description) ? "No description provided" : room.Description)</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    Created by <strong>@room?.CreatedByName</strong> on @room?.CreatedAt.ToString("MMM dd, yyyy HH:mm")
                                </small>
                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="CopyRoomCode">
                                    <i class="bi bi-clipboard me-1"></i> Copy Room Code
                                </button>
                            </div>
                        </div>

                        <!-- Quiz Information Section -->
                        @if (room?.QuizId.HasValue == true)
                        {
                            <div class="mb-4 p-3 bg-light rounded">
                                @if (isLoadingQuiz)
                                {
                                    <div class="text-center py-3">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading quiz details...</span>
                                        </div>
                                        <p>Loading quiz information...</p>
                                    </div>
                                }
                                else if (quizDetails != null)
                                {
                                    <h5>Quiz Information</h5>
                                    <div class="row">
                                        @if (!string.IsNullOrEmpty(quizDetails.ImagePath))
                                        {
                                            <div class="col-md-3 mb-3 mb-md-0">
                                                <img src="@QuizImageService.GetImageUrl(quizDetails.ImagePath)"
                                                     alt="@quizDetails.Name"
                                                     class="img-fluid rounded"
                                                     style="max-height: 150px; object-fit: cover;" />
                                            </div>
                                            <div class="col-md-9">
                                                <h6 class="fw-bold">@quizDetails.Name</h6>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="col-12">
                                                <h6 class="fw-bold">@quizDetails.Name</h6>
                                            </div>
                                        }
                                    </div>

                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <table class="table table-sm">
                                                <tr>
                                                    <td><strong>Category:</strong></td>
                                                    <td>@quizDetails.CategoryName</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Questions:</strong></td>
                                                    <td>@quizDetails.TotalQuestions</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Time:</strong></td>
                                                    <td>@quizDetails.TimeInMinutes min</td>
                                                </tr>
                                            </table>
                                        </div>
                                        @if (!string.IsNullOrEmpty(quizDetails.Description))
                                        {
                                            <div class="col-md-6">
                                                <p><strong>Description:</strong> @quizDetails.Description</p>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-warning mb-0">
                                        Quiz information could not be loaded.
                                    </div>
                                }
                            </div>
                        }

                        <hr />

                        <!-- Room Control Buttons -->
                        @if (room != null && QuizAuthStateProvider.IsLoggedIn)
                        {
                            bool isHost = room.CreatedBy == QuizAuthStateProvider.User.Id;
                            <div class="mb-4">
                                @if (isHost)
                                {
                                    <button type="button" class="btn btn-success btn-lg me-2" @onclick="StartRoom" disabled="@(room.StartedAt.HasValue || participants.Length < 2 || !AreAllParticipantsReady())">
                                        <i class="bi bi-play-circle me-1"></i> @(room.StartedAt.HasValue ? "Room Started" : "Start Room")
                                    </button>
                                    @if (participants.Length < 2)
                                    {
                                        <small class="text-muted">Need at least 2 participants to start</small>
                                    }
                                    else if (!AreAllParticipantsReady())
                                    {
                                        <small class="text-muted">All participants must be ready</small>
                                    }
                                }
                                else
                                {
                                    var currentUser = participants.FirstOrDefault(p => p.UserId == QuizAuthStateProvider.User.Id);
                                    <button type="button" class="btn btn-primary btn-lg" @onclick="ToggleReadyStatus">
                                        <i class="bi bi-check-circle me-1"></i> @(currentUser?.IsReady == true ? "Not Ready" : "Ready")
                                    </button>
                                }
                            </div>
                        }

                        <hr />

                        <h5>Participants (@participants.Length)</h5>
                        <div class="row">
                            @if (participants.Length == 0)
                            {
                                <div class="col-12 text-center py-4">
                                    <p class="text-muted">No participants in this room yet.</p>
                                </div>
                            }
                            else
                            {
                                @foreach (var participant in participants)
                                {
                                    var isHost = room?.CreatedBy == participant.UserId;
                                    var isReady = participant.IsReady;
                                    var isCurrentUserHost = room?.CreatedBy == QuizAuthStateProvider.User.Id;
                                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-4">
                                        <div class="card h-100 @(isHost ? "border border-2 border-warning" : "") @(isReady && !isHost ? "border border-2 border-success" : "")" style="@(isHost ? "position: relative;" : "")">
                                            @if (isHost)
                                            {
                                                <div class="host-badge position-absolute top-0 start-100 translate-middle badge border border-light rounded-circle bg-warning d-flex align-items-center justify-content-center"
                                                     style="width: 24px; height: 24px;"
                                                     title="Room Host">
                                                    <i class="bi bi-star-fill text-white" style="font-size: 0.75rem;"></i>
                                                </div>
                                            }
                                            else if (isReady)
                                            {
                                                <div class="ready-badge position-absolute top-0 start-100 translate-middle badge border border-light rounded-circle bg-success d-flex align-items-center justify-content-center"
                                                     style="width: 24px; height: 24px;"
                                                     title="Ready">
                                                    <i class="bi bi-check text-white" style="font-size: 0.75rem;"></i>
                                                </div>
                                            }
                                            @if (isCurrentUserHost && !isHost) // Show delete button only for host and not for the host themselves
                                            {
                                                <div class="remove-participant position-absolute top-0 start-0 m-2" title="Remove participant from room">
                                                    <button class="btn btn-sm btn-danger" style="width: 24px; height: 24px; padding: 0; border-radius: 50%; font-size: 0.75rem;" @onclick="() => RemoveParticipant(participant.UserId)">
                                                        <i class="bi bi-x text-white"></i>
                                                    </button>
                                                </div>
                                            }
                                            <div class="card-body text-center">
                                                <div class="mb-2">
                                                    @if (!string.IsNullOrEmpty(participant.AvatarPath))
                                                    {
                                                        <img src="https://localhost:7048/@(participant.AvatarPath)" class="rounded-circle @(isHost ? "border border-2 border-warning" : isReady ? "border border-2 border-success" : "")" style="width: 60px; height: 60px; object-fit: cover;" alt="@participant.UserName" />
                                                    }
                                                    else
                                                    {
                                                        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center mx-auto @(isHost ? "border border-2 border-warning" : isReady ? "border border-2 border-success" : "")" style="width: 60px; height: 60px;">
                                                            <span class="text-white fs-4">@participant.UserName.Substring(0, 1).ToUpper()</span>
                                                        </div>
                                                    }
                                                </div>
                                                <h6 class="card-title mb-0">@participant.UserName @(isHost ? "(Host)" : "")</h6>
                                                <small class="text-muted">@(isReady ? "Ready" : "Not Ready")</small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public Guid RoomId { get; set; }

    private RoomDto? room;
    private QuizDetailsDto? quizDetails;
    private RoomParticipantDto[] participants = Array.Empty<RoomParticipantDto>();
    private bool isLoading = true;
    private bool isLoadingQuiz = false;
    private bool isRemovedFromRoom = false; // Flag to track if user was removed from room
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoomData();

        // Make sure SignalR connection is started
        if (!QuizHubService.IsConnected)
        {
            try
            {
                await QuizHubService.StartConnectionAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to establish SignalR connection: {ex.Message}");
                // Optionally show a user-friendly message or continue with limited functionality
                errorMessage = "Real-time updates may not be available due to connection issues. Some features might not work properly.";
            }
        }

        // Set up SignalR connection to receive real-time updates
        QuizHubService.OnParticipantReadyStatusChanged += HandleParticipantReadyStatusChanged;
        QuizHubService.OnQuizStarted += HandleQuizStarted;
        QuizHubService.OnUserRemovedFromRoom += HandleUserRemovedFromRoom; // Subscribe to the old event
        QuizHubService.OnRemovedFromRoom += HandleRemovedFromRoom; // Subscribe to the new event

        // Join the room in SignalR to receive updates
        if (!string.IsNullOrEmpty(room?.Code))
        {
            if (QuizHubService.IsConnected)
            {
                try
                {
                    await QuizHubService.JoinRoomAsync(room.Code);
                    Console.WriteLine($"Successfully joined room {room.Code} via SignalR");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to join room via SignalR: {ex.Message}");
                    errorMessage = "Unable to join the room for real-time updates. Some features might not work properly.";
                }
            }
            else
            {
                Console.WriteLine($"SignalR not connected, skipping JoinRoom call for room {room?.Code}");
            }
        }

        // Start polling for participants (as backup)
        _ = PollParticipantsAsync();
    }

    private async Task LoadRoomData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            room = await RoomApi.GetRoomByIdAsync(RoomId);
            await LoadParticipants();

            // Load quiz details if the room has a quiz
            if (room?.QuizId.HasValue == true)
            {
                await LoadQuizDetails();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load room data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadParticipants()
    {
        try
        {
            participants = await RoomApi.GetRoomParticipantsAsync(RoomId);
            
            // Check if the current user is still in the room
            if (QuizAuthStateProvider.IsLoggedIn && !participants.Any(p => p.UserId == QuizAuthStateProvider.User.Id))
            {
                // Current user is no longer in the room, redirect to home
                isRemovedFromRoom = true;
                
                // Leave the room in SignalR before navigating away
                if (!string.IsNullOrEmpty(room?.Code))
                {
                    await QuizHubService.LeaveRoomAsync(room.Code);
                }
                
                // Navigate to home page
                await InvokeAsync(() =>
                {
                    Navigation.NavigateTo("/student/home");
                });
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load participants: {ex.Message}";
        }
    }

    private async Task LoadQuizDetails()
    {
        if (room?.QuizId == null) return;

        isLoadingQuiz = true;
        StateHasChanged();

        try
        {
            var response = await StudentQuizApi.GetQuizDetailsAsync(room.QuizId.Value);
            if (response.IsSuccess)
            {
                quizDetails = response.Data;
            }
            else
            {
                errorMessage = $"Failed to load quiz details: {response.ErrorMessage}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load quiz details: {ex.Message}";
        }
        finally
        {
            isLoadingQuiz = false;
            StateHasChanged();
        }
    }

    private async Task PollParticipantsAsync()
    {
        while (!string.IsNullOrEmpty(room?.Code) && !isRemovedFromRoom)
        {
            try
            {
                await LoadParticipants();
                
                // Check if the current user is still in the room
                if (QuizAuthStateProvider.IsLoggedIn && !participants.Any(p => p.UserId == QuizAuthStateProvider.User.Id))
                {
                    // Current user is no longer in the room, redirect to home
                    isRemovedFromRoom = true;
                    
                    // Leave the room in SignalR before navigating away
                    if (!string.IsNullOrEmpty(room?.Code))
                    {
                        await QuizHubService.LeaveRoomAsync(room.Code);
                    }
                    
                    // Navigate to home page
                    await InvokeAsync(() =>
                    {
                        Navigation.NavigateTo("/student/home");
                    });
                    
                    break; // Stop polling
                }
                
                StateHasChanged();
                await Task.Delay(5000); // Refresh every 5 seconds
            }
            catch
            {
                // Ignore errors in polling
                break;
            }
        }
    }

    private async Task CopyRoomCode()
    {
        if (room != null)
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", room.Code);
            await ShowAlertAsync("Room code copied to clipboard!", "Copied");
        }
    }

    private void LeaveRoom()
    {
        Navigation.NavigateTo("/student/home");
    }

    private async Task ShowAlertAsync(string message, string title = "Error") =>
        await JSRuntime.InvokeVoidAsync("alert", $"{title}\n{message}");

    private bool AreAllParticipantsReady()
    {
        // Check if all participants except the host are ready
        return participants.All(p => p.IsReady || room?.CreatedBy == p.UserId);
    }

    private async Task ToggleReadyStatus()
    {
        if (room == null || !QuizAuthStateProvider.IsLoggedIn)
        {
            await ShowAlertAsync("You must be logged in to set ready status", "Error");
            return;
        }

        // Check if user is the host (hosts can't be ready, they start the room)
        if (room.CreatedBy == QuizAuthStateProvider.User.Id)
        {
            await ShowAlertAsync("Host cannot set ready status", "Error");
            return;
        }

        var currentUser = participants.FirstOrDefault(p => p.UserId == QuizAuthStateProvider.User.Id);
        if (currentUser?.IsReady == true)
        {
            // Set to not ready
            var response = await RoomApi.SetNotReadyStatusAsync(room.Id);
            if (response.IsSuccessStatusCode)
            {
                await ShowAlertAsync("You are no longer ready", "Status Update");
            }
            else
            {
                await ShowAlertAsync($"Failed to update status: {response.Error}", "Error");
            }
        }
        else
        {
            // Set to ready
            var response = await RoomApi.SetReadyStatusAsync(room.Id);
            if (response.IsSuccessStatusCode)
            {
                await ShowAlertAsync("You are now ready", "Status Update");
            }
            else
            {
                await ShowAlertAsync($"Failed to update status: {response.Error}", "Error");
            }
        }

        // Refresh participants to get updated status
        await LoadParticipants();

        // Also notify via SignalR that the status changed
        if (room != null && QuizHubService.IsConnected)
        {
            try
            {
                var isCurrentlyReady = participants.FirstOrDefault(p => p.UserId == QuizAuthStateProvider.User.Id)?.IsReady == true;
                await QuizHubService.NotifyParticipantReadyAsync(room.Code, QuizAuthStateProvider.User.Name, isCurrentlyReady);
                Console.WriteLine($"Successfully notified ready status via SignalR for room {room.Code}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to notify ready status via SignalR: {ex.Message}");
                // Don't show error to user for this as it's not critical
            }
        }

        StateHasChanged();
    }

    private async Task StartRoom()
    {
        if (room == null || !QuizAuthStateProvider.IsLoggedIn)
        {
            await ShowAlertAsync("You must be logged in to start the room", "Error");
            return;
        }

        // Check if current user is the host
        if (room.CreatedBy != QuizAuthStateProvider.User.Id)
        {
            await ShowAlertAsync("Only the host can start the room", "Permission Error");
            return;
        }

        // Check if there are enough participants
        if (participants.Length < 2)
        {
            await ShowAlertAsync("Need at least 2 participants to start the room", "Not Enough Participants");
            return;
        }

        // Refresh participants list to ensure we have the latest ready status
        await LoadParticipants();

        // Check if all participants are ready
        var nonReadyParticipants = participants.Where(p => p.UserId != room.CreatedBy && !p.IsReady).ToList();
        if (nonReadyParticipants.Any())
        {
            var nonReadyNames = string.Join(", ", nonReadyParticipants.Select(p => p.UserName));
            await ShowAlertAsync($"The following users are not ready: {nonReadyNames}. All participants must be ready to start.", "Not Ready");
            return;
        }

        // Call API to start the room
        var response = await RoomApi.StartRoomAsync(room.Id);
        if (response.IsSuccessStatusCode)
        {
            await ShowAlertAsync("Room started successfully!", "Success");

            // Notify other participants via SignalR that the quiz has started
            if (QuizHubService.IsConnected && !string.IsNullOrEmpty(room.Code))
            {
                try
                {
                    await QuizHubService.StartQuizAsync(room.Code);
                    Console.WriteLine($"Successfully sent start quiz notification via SignalR for room {room.Code}");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to send start quiz notification via SignalR: {ex.Message}");
                    // Still allow navigation even if SignalR notification fails
                }
            }

            // Navigate to the quiz room page immediately - participants will receive the SignalR event
            if (room.QuizId.HasValue)
            {
                Navigation.NavigateTo($"/student/quiz/{room.QuizId.Value}/room/{room.Id}");
            }
            else
            {
                await ShowAlertAsync("No quiz assigned to this room", "Error");
            }
        }
        else
        {
            // Get the specific error message from the API response
            string errorMessage = "Failed to start room";
            if (response.Error?.Message != null)
            {
                errorMessage = response.Error.Message;
            }
            await ShowAlertAsync($"Failed to start room: {errorMessage}", "Error");
        }
    }

    private async Task RemoveParticipant(int userId)
    {
        // Double check if the current user is the host
        if (room?.CreatedBy != QuizAuthStateProvider.User.Id)
        {
            await ShowAlertAsync("Only the host can remove participants", "Permission Error");
            return;
        }

        // Confirm removal with user
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to remove this participant from the room?");
        if (!confirmed)
        {
            return; // User cancelled
        }

        // Call the API to remove the participant
        var response = await RoomApi.RemoveParticipantAsync(room.Id, userId);
        if (response.IsSuccessStatusCode)
        {
            // Refresh the participant list to reflect the changes
            await LoadParticipants();
            StateHasChanged();
            await ShowAlertAsync("Participant removed successfully", "Success");

            // Notify the removed participant via SignalR
            if (QuizHubService.IsConnected && !string.IsNullOrEmpty(room?.Code))
            {
                try
                {
                    await QuizHubService.NotifyParticipantRemovedAsync(room.Code, userId);
                    Console.WriteLine($"Successfully notified participant removal via SignalR for room {room?.Code}, user ID: {userId}");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to notify participant removal via SignalR: {ex.Message}");
                    // Don't prevent the action if SignalR notification fails
                }
            }
        }
        else
        {
            await ShowAlertAsync($"Failed to remove participant: {response.Error?.Message}", "Error");
        }
    }

    private async void HandleQuizStarted(string roomCode)
    {
        if (room?.Code == roomCode && room.QuizId.HasValue)
        {
            await InvokeAsync(StateHasChanged); // Ensure UI is updated before navigation
            Navigation.NavigateTo($"/student/quiz/{room.QuizId.Value}/room/{room.Id}");
        }
    }

    private async void HandleParticipantReadyStatusChanged(string userName, bool isReady)
    {
        await InvokeAsync(async () =>
        {
            // Update the participant's ready status in the local list
            for (int i = 0; i < participants.Length; i++)
            {
                if (participants[i].UserName == userName)
                {
                    var updatedParticipants = participants.ToList();
                    updatedParticipants[i] = new RoomParticipantDto
                    {
                        UserId = participants[i].UserId,
                        UserName = participants[i].UserName,
                        AvatarPath = participants[i].AvatarPath,
                        IsReady = isReady
                    };
                    participants = updatedParticipants.ToArray();
                    break;
                }
            }

            StateHasChanged();
        });
    }

    private async void HandleUserRemovedFromRoom(string roomCode, string roomName, string hostName)
    {
        await InvokeAsync(async () =>
        {
            // Set flag to indicate user was removed from room
            isRemovedFromRoom = true;

            // Show notification that user was removed from the room
            await ShowAlertAsync($"You have been removed from room '{roomName}' by {hostName}.", "Removed from Room");

            // Leave the room in SignalR before navigating away
            if (!string.IsNullOrEmpty(roomCode))
            {
                await QuizHubService.LeaveRoomAsync(roomCode);
            }

            // Navigate to home page
            Navigation.NavigateTo("/student/home");
        });
    }

    private async void HandleRemovedFromRoom(string roomCode, string message)
    {
        await InvokeAsync(async () =>
        {
            // Set flag to indicate user was removed from room
            isRemovedFromRoom = true;

            // Show the specific message sent from the host as a temporary notification
            await JSRuntime.InvokeVoidAsync("showTemporaryNotification", message, 10000); // Show for 10 seconds

            // Leave the room in SignalR before navigating away
            if (!string.IsNullOrEmpty(roomCode))
            {
                await QuizHubService.LeaveRoomAsync(roomCode);
            }

            // Wait for 10 seconds then navigate to home page
            await Task.Delay(10000);
            Navigation.NavigateTo("/student/home");
        });
    }

    public async ValueTask DisposeAsync()
    {
        // Unsubscribe from SignalR events
        QuizHubService.OnParticipantReadyStatusChanged -= HandleParticipantReadyStatusChanged;
        QuizHubService.OnQuizStarted -= HandleQuizStarted;
        QuizHubService.OnUserRemovedFromRoom -= HandleUserRemovedFromRoom;
        QuizHubService.OnRemovedFromRoom -= HandleRemovedFromRoom; // Unsubscribe from new event

        // Leave the room in SignalR when leaving the page
        if (!string.IsNullOrEmpty(room?.Code))
        {
            try
            {
                await QuizHubService.LeaveRoomAsync(room.Code);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error leaving room via SignalR: {ex.Message}");
            }
        }
    }
}

<script>
    window.showTemporaryNotification = function(message, duration) {
        // Remove any existing notification
        let existingNotification = document.getElementById('temporary-notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        // Create notification container
        let notification = document.createElement('div');
        notification.id = 'temporary-notification';
        notification.className = 'position-fixed top-50 start-50 translate-middle rounded p-3 text-white bg-danger';
        notification.style.cssText = 'z-index: 9999; min-width: 300px; text-align: center;';
        notification.innerHTML = '<div class="d-flex align-items-center justify-content-center gap-2"><i class="bi bi-exclamation-triangle-fill me-2"></i><span>' + message + '</span></div>';

        document.body.appendChild(notification);

        // Auto remove after the specified duration
        setTimeout(function() {
            if (notification && notification.parentNode) {
                notification.remove();
            }
        }, duration);
    };
</script>