@page "/student/flashcard-quiz"
@using BlazingQuiz.Shared.Components.Apis
@using BlazingQuiz.Shared.DTOs
@using BlazingQuiz.Shared.Components.Components

@layout QuizPageLayout 
@inject NavigationManager NavigationManager
@inject QuizState QuizState
@inject IStudentQuizApi StudentQuizApi
@inject IAppState AppState

@if(QuizState.Quiz != null)
{
    <div class="container-fluid">
        <div class="row mb-3">
            <div class="col-sm-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h6>Question @(_currentIndex + 1) of @_questions.Count</h6>
                    <div>
                        <QuizTimer TotalMinutes="QuizState.Quiz.TimeInMinutes" OnTimerStop="AutoSubmitQuizAsync" />
                    </div>
                </div>

                @if (_questions.Any())
                {
                    @if (_isPageReady)
                    {
                        <div class="flip-card-container">
                            <div class="flip-card @(IsFlipped ? "flipped" : "")" id="flip-card-@_currentIndex">
                                <div class="card-face card-front">
                                    <h5 class="card-question">@_currentQuestion.Text</h5>
                                    @if (!_currentQuestion.IsTextAnswer && _currentQuestion.Options.Any())
                                    {
                                        <div class="card-options mt-3">
                                            @foreach (var option in _currentQuestion.Options)
                                            {
                                                <div class="card-option">@option.Text</div>
                                            }
                                        </div>
                                    }
                                    <div class="card-hint flip-indicator">
                                        <i class="bi bi-arrow-repeat"></i> Click card or button to flip
                                    </div>
                                </div>
                                <div class="card-face card-back">
                                    <h5 class="card-question">Answer</h5>
                                    @if (_currentQuestion.IsTextAnswer)
                                    {
                                        <div class="card-answer mt-3">
                                            @if (_currentQuestion.TextAnswers != null && _currentQuestion.TextAnswers.Any())
                                            {
                                                <ul class="list-unstyled">
                                                    @foreach (var answer in _currentQuestion.TextAnswers)
                                                    {
                                                        <li class="mb-2">
                                                            <span class="badge bg-success">@answer</span>
                                                        </li>
                                                    }
                                                </ul>
                                            }
                                            else
                                            {
                                                <p class="text-muted">No answer provided</p>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="card-answer mt-3">
                                            @if (_currentQuestion.Options != null && _currentQuestion.Options.Any())
                                            {
                                                var correctOptions = _currentQuestion.Options.Where(o => o.IsCorrect).ToList();
                                                if (correctOptions.Any())
                                                {
                                                    <ul class="list-unstyled">
                                                        @foreach (var option in correctOptions)
                                                        {
                                                            <li class="mb-2">
                                                                <span class="badge bg-success">@option.Text</span>
                                                            </li>
                                                        }
                                                    </ul>
                                                }
                                                else
                                                {
                                                    <p class="text-muted">No correct answer marked</p>
                                                }
                                            }
                                        </div>
                                    }
                                    <div class="card-hint flip-indicator">
                                        <i class="bi bi-arrow-repeat"></i> Click card or button to flip back
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-outline-secondary" @onclick="PreviousQuestion" disabled="@(_currentIndex == 0)">
                                <i class="bi bi-chevron-left"></i> Previous
                            </button>

                            <button class="btn btn-primary" @onclick="ToggleFlip">
                                <i class="bi bi-arrow-repeat"></i> @_flipButtonText
                            </button>

                            @if (_currentIndex == _questions.Count - 1)
                            {
                                <button class="btn btn-success" @onclick="SubmitQuizAsync">
                                    Submit Quiz <i class="bi bi-check2"></i>
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-outline-primary" @onclick="NextQuestion">
                                    Next <i class="bi bi-chevron-right"></i>
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
}
else
{
    <div class="text-center mt-5">
        <h3>No Quiz Selected</h3>
        <p>You must start a quiz first from the 'My Quizzes' page.</p>
        <div class="mt-4">
            <a href="/student/home" class="btn btn-primary me-2">Go to Home</a>
            <a href="/student/my-quizes" class="btn btn-secondary">My Quizzes</a>
        </div>
    </div>
}

@if (_submitQuizMessage != null)
{
    <Modal Title="Quiz Submitted" OnActionButtonClick="RedirectToMyQuizes" OnCancelClick="RedirectToMyQuizes">
        <p class="text-success h5">@_submitQuizMessage</p>
    </Modal>
}

@if (_errorMessage != null)
{
    <div class="alert alert-danger mt-3">
        @_errorMessage
        <button type="button" class="btn-close" @onclick="() => _errorMessage = null"></button>
    </div>
}

@code {
    private List<QuestionDto> _questions = new();
    private QuestionDto _currentQuestion = new();
    private int _currentIndex = 0;
    private bool _isFlipped = false;
    private string _flipButtonText = "Flip Card";
    private string? _errorMessage;
    private string? _submitQuizMessage;
    private bool _isPageReady = false;

    protected override async Task OnInitializedAsync()
    {
        if(QuizState.Quiz == null || QuizState.StudentQuizId == 0)
        {
            NavigationManager.NavigateTo("student/home", replace: true);
            return;
        }

        AppState.ShowLoader("Loading questions...");
        try
        {
            // Load all questions for the quiz
            var allQuestionsResult = await StudentQuizApi.GetAllQuestionsForQuizAsync(QuizState.StudentQuizId);
            if (allQuestionsResult.IsSuccess && allQuestionsResult.Data != null)
            {
                _questions = allQuestionsResult.Data.ToList();
                if (_questions.Any())
                {
                    _currentQuestion = _questions[_currentIndex];
                    _isPageReady = true;
                }
                else
                {
                    _errorMessage = "No questions available for this quiz";
                }
            }
            else
            {
                _errorMessage = allQuestionsResult.ErrorMessage ?? "Failed to load questions";
                Console.WriteLine($"GetAllQuestionsForQuiz Error: {allQuestionsResult.ErrorMessage}"); // Log for debugging
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred while loading questions: {ex.Message}";
            Console.WriteLine($"GetAllQuestionsForQuiz Exception: {ex.Message}\nStack Trace: {ex.StackTrace}"); // Log for debugging
            AppState.ShowError($"Failed to load quiz questions: {ex.Message}");
        }
        finally
        {
            AppState.HideLoader();
        }
    }

    private bool IsFlipped => _isFlipped;

    private void NextQuestion()
    {
        if (_currentIndex < _questions.Count - 1)
        {
            _currentIndex++;
            _currentQuestion = _questions[_currentIndex];
            _isFlipped = false; // Reset flip state for new question
            _flipButtonText = "Flip Card";
        }
    }

    private void PreviousQuestion()
    {
        if (_currentIndex > 0)
        {
            _currentIndex--;
            _currentQuestion = _questions[_currentIndex];
            _isFlipped = false; // Reset flip state for new question
            _flipButtonText = "Flip Card";
        }
    }

    private void ToggleFlip()
    {
        _isFlipped = !_isFlipped;
        _flipButtonText = _isFlipped ? "Flip Back" : "Flip Card";
    }

    private async Task OnFlipChangedAsync(bool isFlipped)
    {
        _isFlipped = isFlipped;
        _flipButtonText = _isFlipped ? "Flip Back" : "Flip Card";
    }

    private void OnCardFlipped()
    {
        // Optional: Handle card flip event for analytics or other purposes
    }

    private async Task SubmitQuizAsync()
    {
        try
        {
            AppState.ShowLoader("Submitting quiz...");
            QuizApiResponse result = await StudentQuizApi.SubmitQuizAsync(QuizState.StudentQuizId);
            if(!result.IsSuccess)
            {
                _errorMessage = result.ErrorMessage ?? "An error occurred while submitting the quiz";
                Console.WriteLine($"Flashcard SubmitQuiz Error: {result.ErrorMessage}"); // Log for debugging
                return;
            }

            _submitQuizMessage = "Quiz submitted successfully";
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred while submitting the quiz: {ex.Message}";
            Console.WriteLine($"Flashcard SubmitQuiz Exception: {ex.Message}\nStack Trace: {ex.StackTrace}"); // Log for debugging
            AppState.ShowError($"Quiz submission failed: {ex.Message}");
        }
        finally
        {
            AppState.HideLoader();
        }
    }

    private async Task AutoSubmitQuizAsync()
    {
        try
        {
            AppState.ShowLoader("Auto submitting the quiz");
            QuizApiResponse result = await StudentQuizApi.AutoSubmitQuizAsync(QuizState.StudentQuizId);
            if(!result.IsSuccess)
            {
                _errorMessage = result.ErrorMessage ?? "An error occurred while auto-submitting the quiz";
                Console.WriteLine($"Flashcard AutoSubmitQuiz Error: {result.ErrorMessage}"); // Log for debugging
                return;
            }

            _submitQuizMessage = "Quiz submitted successfully";
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred while auto-submitting the quiz: {ex.Message}";
            Console.WriteLine($"Flashcard AutoSubmitQuiz Exception: {ex.Message}\nStack Trace: {ex.StackTrace}"); // Log for debugging
            AppState.ShowError($"Quiz auto-submission failed: {ex.Message}");
        }
        finally
        {
            AppState.HideLoader();
        }
    }

    private void RedirectToMyQuizes()
    {
        QuizState.StopQuiz();
        NavigationManager.NavigateTo("student/my-quizes", replace: true);
    }
}

<style>
    .flip-card-container {
        perspective: 1000px;
        margin: 20px 0;
        display: flex;
        justify-content: center;
    }

    .flip-card {
        width: 100%;
        height: 300px;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.6s;
        cursor: pointer;
    }

    .flip-card.flipped {
        transform: rotateY(180deg);
    }

    .card-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        text-align: center;
    }

    .card-front {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        color: white;
    }

    .card-back {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        transform: rotateY(180deg);
    }

    .card-question {
        font-weight: 600;
        margin-bottom: 15px;
    }

    .card-options, .card-answer {
        width: 100%;
    }

    .card-option {
        background: rgba(255,255,255,0.2);
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        border: 1px solid rgba(255,255,255,0.3);
    }

    .card-hint {
        position: absolute;
        bottom: 10px;
        width: 100%;
        text-align: center;
        font-size: 0.8em;
        opacity: 0.7;
    }

    .flip-indicator {
        color: rgba(255,255,255,0.8);
    }

    /* (max-width: 768px) {
        .flip-card {
            height: 250px;
        }

        .card-question {
            font-size: 1.1rem;
        }
    } */
</style>