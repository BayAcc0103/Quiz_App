@page "/student/profile"
@using BlazingQuiz.Shared
@using BlazingQuiz.Shared.DTOs
@using BlazingQuiz.Shared.Components.Apis
@inject IAuthApi AuthApi
@inject UserAvatarService UserAvatarService
@inject IAppState AppState
@inject QuizAuthStateProvider QuizAuthStateProvider
@inject NavigationManager NavigationManager
@inject ProfileUpdateService ProfileUpdateService
@inject IJSRuntime JSRuntime

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="hanging-container">
                <div class="hanging-content">
                    <h3>Student Profile</h3>
                </div>
                <div class="rope left-rope"></div>
                <div class="rope right-rope"></div>
            </div>
            <div class="card card-3d-raised card-light">
                <div class="card-body">
                    @if (_isLoading)
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (_error != null)
                    {
                        <div class="alert alert-danger card-3d-raised" role="alert">
                            @_error
                        </div>
                    }
                    else
                    {
                        <EditForm Model="_userDto" OnValidSubmit="UpdateProfileAsync">
                            <DataAnnotationsValidator />

                            <!-- Avatar Section -->
                            <div class="mb-4 text-center">
                                <label class="form-label">Profile Avatar</label>
                                <div class="d-flex justify-content-center">
                                    <div class="position-relative">
                                        @if (!string.IsNullOrEmpty(_userDto.AvatarPath))
                                        {
                                            <img src="@UserAvatarService.GetImageUrl(_userDto.AvatarPath)"
                                                 alt="Avatar"
                                                 class="rounded-circle avatar-centered"
                                                 style="width: 150px; height: 150px; object-fit: cover; border: 2px solid #dee2e6;" />
                                        }
                                        else
                                        {
                                            <img src="@UserAvatarService.GetImageUrl("images/user-avatars/default-avatar.svg")"
                                                 alt="Avatar"
                                                 class="rounded-circle avatar-centered"
                                                 style="width: 150px; height: 150px; object-fit: cover; border: 2px solid #dee2e6;" />
                                        }
                                        <button type="button"
                                                class="btn btn-primary avatar-add-btn rounded-circle position-absolute shadow-sm"
                                                style="bottom: 0; right: 0; transform: translate(25%, 25%); width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1rem; border: 2px solid white;"
                                                @onclick="OpenAvatarFileDialog">
                                            <span class="material-symbols-outlined">
                                                add_photo_alternate
                                            </span>
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    @if (!string.IsNullOrEmpty(_userDto.AvatarPath))
                                    {
                                        <button type="button" class="btn btn-3d btn-3d-secondary btn-sm" @onclick="RemoveAvatarAsync">Remove Avatar</button>
                                    }
                                </div>
                                <!-- Hidden file input for avatar selection -->
                                <InputFile id="avatarFileInput"
                                           OnChange="@OnAvatarFileChanged"
                                           style="display: none;"
                                           accept="image/*" />
                            </div>

                            <!-- Profile Form -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="name" class="form-label">Name</label>
                                    <input id="name" class="form-control text-center form-control-join" @bind="_userDto.Name" />
                                    <ValidationMessage For="@(() => _userDto.Name)" class="text-danger" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input id="email" type="email" class="form-control text-center form-control-join" @bind="_userDto.Email" disabled="true" />
                                    <ValidationMessage For="@(() => _userDto.Email)" class="text-danger" />
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label">Phone</label>
                                    <input id="phone" class="form-control text-center form-control-join" @bind="_userDto.Phone" />
                                    <ValidationMessage For="@(() => _userDto.Phone)" class="text-danger" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="role" class="form-label">Role</label>
                                    <input id="role" class="form-control text-center form-control-join" @bind="_role" disabled="true" />
                                </div>
                            </div>
                            @if (!string.IsNullOrEmpty(_error))
                            {
                                <div class="alert alert-danger" role="alert">
                                    @_error
                                </div>
                            }
                            <div class="row mt-3">
                                <div class="col-md-6 mb-2 d-flex justify-content-center align-content-center">
                                    <button type="submit" class="btn btn-3d btn-3d-primary w-100" disabled="@_isUpdating">
                                        @if (_isUpdating)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                            <span>Updating...</span>
                                        }
                                        else
                                        {
                                            <span><i class="bi bi-save"></i> Update Profile</span>
                                        }
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2 d-flex justify-content-center align-content-center">
                                    <button type="button" class="btn btn-3d btn-3d-secondary w-100" @onclick="ChangePassword">Change Password</button>
                                </div>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private UserDto _userDto = new UserDto(0, "", "", "", false, null);
    private bool _isLoading = true;
    private bool _isUploading = false;
    private bool _isUpdating = false;
    private int _uploadProgress = 0;
    private string? _error;
    private string _role = "";
    private string _status = "";
    private string _userId = "";
    private IBrowserFile? _selectedAvatarFile;

    protected override async Task OnInitializedAsync()
    {
        await LoadProfileAsync();
    }

    private async Task LoadProfileAsync()
    {
        try
        {
            _isLoading = true;
            _userDto = await AuthApi.GetProfileAsync();

            // Set display values
            _role = QuizAuthStateProvider.User?.Role ?? "Student";
            _status = _userDto.IsApproved ? "Approved" : "Pending Approval";
            _userId = _userDto.Id.ToString();
        }
        catch (Exception ex)
        {
            _error = $"Error loading profile: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task UpdateProfileAsync()
    {
        try
        {
            _isUpdating = true;
            StateHasChanged();

            AppState.ShowLoader("Updating profile...");
            await AuthApi.UpdateProfileAsync(_userDto);
            ProfileUpdateService.NotifyAvatarUpdated(); // Notify other components about potential avatar update
            AppState.ShowAlert("Profile updated successfully!", AlertType.Success);
        }
        catch (Exception ex)
        {
            AppState.ShowAlert($"Error updating profile: {ex.Message}", AlertType.Error);
        }
        finally
        {
            _isUpdating = false;
            AppState.HideLoader();
            StateHasChanged();
        }
    }

    private async Task OnAvatarFileChanged(InputFileChangeEventArgs e)
    {
        var file = e.File;
        _selectedAvatarFile = file;

        // If a file is selected, automatically upload it
        if (file != null)
        {
            await UploadAvatarAsync(file);
        }
    }

    private async Task OpenAvatarFileDialog()
    {
        await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('avatarFileInput').click();");
    }

    private async Task UploadAvatarAsync(IBrowserFile file)
    {
        if (file == null) return;

        if (file.Size > 5 * 1024 * 1024) // 5MB limit
        {
            AppState.ShowAlert("File size must be less than 5MB", AlertType.Error);
            return;
        }

        var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif", ".webp" };
        var extension = Path.GetExtension(file.Name).ToLowerInvariant();
        if (!allowedExtensions.Contains(extension))
        {
            AppState.ShowAlert("Only image files (JPG, PNG, GIF, WebP) are allowed", AlertType.Error);
            return;
        }

        try
        {
            _isUploading = true;

            // Simulate progress tracking
            _uploadProgress = 0;
            StateHasChanged();

            for (int i = 0; i <= 10; i++)
            {
                await Task.Delay(30); // Small delay to simulate progress
                _uploadProgress = i * 10;
                StateHasChanged();
            }

            var result = await UserAvatarService.UploadAvatarAsync(file);

            if (result.IsSuccess)
            {
                _uploadProgress = 100; // Set to 100% on success
                StateHasChanged();

                // Reload profile to get the new avatar
                await LoadProfileAsync();
                ProfileUpdateService.NotifyAvatarUpdated(); // Notify other components about avatar update
                AppState.ShowAlert("Avatar uploaded successfully!", AlertType.Success);

                // Clear the selected file after successful upload
                _selectedAvatarFile = null;
            }
            else
            {
                AppState.ShowAlert($"Failed to upload avatar: {result.ErrorMessage}", AlertType.Error);
            }
        }
        catch (Exception ex)
        {
            AppState.ShowAlert($"Error uploading avatar: {ex.Message}", AlertType.Error);
        }
        finally
        {
            _isUploading = false;
            StateHasChanged();
        }
    }

    private async Task RemoveAvatarAsync()
    {
        try
        {
            var result = await UserAvatarService.RemoveAvatarAsync();
            if (result.IsSuccess)
            {
                // Reload profile to update avatar display
                await LoadProfileAsync();
                ProfileUpdateService.NotifyAvatarUpdated(); // Notify other components about avatar update
                AppState.ShowAlert("Avatar removed successfully!", AlertType.Success);
            }
            else
            {
                AppState.ShowAlert($"Failed to remove avatar: {result.ErrorMessage}", AlertType.Error);
            }
        }
        catch (Exception ex)
        {
            AppState.ShowAlert($"Error removing avatar: {ex.Message}", AlertType.Error);
        }
    }

    private void ChangePassword()
    {
        // Navigate to change password page
        var currentUri = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.NavigateTo($"/student/changepassword");
    }
}